
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>خارجي طلاب</title>
    <style>
:root {
    --primary-color: #4a90e2;
    --secondary-color: #2ecc71;
    --background-color: #f5f7fa;
    --text-color: #2c3e50;
    --border-radius: 12px;
    --box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    --invalid-bg-color: #fff5f5;
    --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    background-color: var(--background-color);
    color: var(--text-color);
    line-height: 1.6;
}

.container {
    background-color: #ffffff;
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    width: 95%;
    max-width: 1000px;
    position: relative;
    overflow: hidden;
    transition: var(--transition);
}

.container:hover {
    box-shadow: 0 15px 30px rgba(0,0,0,0.15);
}

.title {
    text-align: center;
    font-size: 2.5rem;
    color: var(--primary-color);
    margin-bottom: 2rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    position: relative;
}

.title::after {
    content: '';
    display: block;
    width: 50px;
    height: 3px;
    background-color: var(--primary-color);
    margin: 10px auto 0;
}

input, select {
    width: 100%;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 2px solid #e0e0e0;
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: var(--transition);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-color: #ffffff;
    box-sizing: border-box; 
}

input:hover, select:hover {
    border-color: var(--primary-color);
}

select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%234a90e2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1.5em;
    padding-right: 3rem;
}

select option:first-child {
    color: #7f8c8d;
}

select:not(:focus):invalid,
select:invalid,
select:required:invalid {
    color: #7f8c8d;
    background-color: #f6f6f6;
}

input:focus, select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
}

.button-container {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
    margin-bottom: 2rem;
}

.btn {
    background-color: var(--primary-color);
    color: white;
    border: none;
    cursor: pointer;
    font-weight: bold;
    text-transform: uppercase;
    transition: var(--transition);
    padding: 1rem 2rem;
    font-size: 1.1rem;
    border-radius: 50px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background-color: rgba(255,255,255,0.2);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.6s ease-out, height 0.6s ease-out;
}

.btn:hover::before {
    width: 300%;
    height: 300%;
}

.btn:hover {
    background-color: #3a7bc8;
    transform: translateY(-2px);
    box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}

#results, #legacyResults {
    margin-top: 2rem;
    width: 100%;
    overflow-x: auto;
}

.autocomplete-items {
    border: 2px solid #e0e0e0;
    border-top: none;
    border-radius: 0 0 var(--border-radius) var(--border-radius);
    max-height: 300px;
    overflow-y: auto;
    position: absolute;
    z-index: 99;
    background-color: #ffffff;
    width: calc(100% - 4rem);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.autocomplete-items div {
    padding: 1rem;
    cursor: pointer;
    background-color: #fff;
    border-bottom: 1px solid #e0e0e0;
    transition: var(--transition);
}

.autocomplete-items div:hover, .autocomplete-active {
    background-color: #ecf0f1;
    transform: translateX(5px);
}

.already-in-table {
    background-color: #fff5f5;
    color: #c0392b;
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
    margin-top: 1.5rem;
    background-color: #fff;
}

th, td {
    padding: 1rem;
    text-align: left;
}

th {
    background-color: var(--primary-color);
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 1px;
}

tr {
    background-color: #f8f9fa;
    transition: var(--transition);
}

tr:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.recycle-bin {
    font-size: 1.8rem;
    color: #e74c3c;
    cursor: pointer;
    transition: var(--transition);
}

.recycle-bin:hover {
    transform: scale(1.2);
}

.delete-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: var(--transition);
}

.delete-btn:hover {
    transform: scale(1.2);
    background-color: rgba(231, 76, 60, 0.1);
}

.delete-btn svg {
    width: 24px;
    height: 24px;
    stroke: #e74c3c;
}

.product-unit {
    color: var(--primary-color);
    font-weight: bold;
}

#legacyMode {
    display: none;
    padding: 1rem;
    border-radius: var(--border-radius);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ffffff;
    overflow-y: auto;
    z-index: 1000;
}

.selected-row {
    background-color: #ecf0f1;
}

.legacy-mode-toggle {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    align-items: center;
    font-size: 0.9rem;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
    margin-left: 10px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #cccccc; 
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: rgba(46, 204, 113, 0.2);
}

input:checked + .slider:before {
    transform: translateX(26px);
}

td[contenteditable="true"] {
    background-color: #f9f9f9;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 0.6rem;
    transition: var(--transition);
}

td[contenteditable="true"]:hover, td[contenteditable="true"]:focus {
    background-color: #f0f0f0;
    border-color: #bdc3c7;
    box-shadow: 0 0 5px rgba(74, 144, 226, 0.5);
}

td[contenteditable="true"]::before {
    content: '';
    display: inline-block;
    width: 20px;
    height: 20px;
    margin-right: 5px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234a90e2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
    vertical-align: middle;
}

td[contenteditable="true"]:focus::before {
    display: none;
}

#saveAndExitBtn {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    padding: 1em 2em;
    font-size: 1em;
    font-weight: bold;
    color: white;
    background-color: var(--primary-color);
    border: none;
    border-radius: 0.5em;
    cursor: pointer;
    box-shadow: 0 0.25em 0.375em rgba(0, 0, 0, 0.1);
    transition: var(--transition);
    width: auto;
    max-width: 90%;
}

#saveAndQuitBtn:hover {
    background-color: #3a7bc8;
    transform: translateX(-50%) translateY(-2px);
    box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
    backdrop-filter: blur(5px);
}

.modal.show {
    display: block; 
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #bdc3c7;
    width: 80%;
    max-width: 500px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    position: relative; 
    transform: none; /
    opacity: 1; 
    transition: all 0.3s ease-out;
}

.modal-content h2 {
    color: var(--primary-color);
    margin-bottom: 20px;
}

.modal-content select,
.modal-content input {
    width: 100%;
    margin-bottom: 15px;
}

.modal-content .button-container {
    justify-content: flex-end;
    margin-top: 20px;
}

#addNameBtn {
    background-color: var(--secondary-color);
}

#addNameBtn:hover {
    background-color: #27ae60;
}

#addNameBtn:disabled {
    background-color: #95a5a6;
    cursor: not-allowed;
}

.report-header {
    background-color: #f8f9fa;
    border: 2px solid #4a90e2;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    text-align: right;
    direction: rtl;
    display: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.report-header p {
    margin: 0.5rem 0;
    font-size: 1.2rem;
    color: #2c3e50;
}

.report-header span {
    font-weight: bold;
    color: #4a90e2;
}
@media print {
    body {
        padding: 20px;
        margin: 0;
    }

    .container {
        box-shadow: none;
        padding: 0;
        margin: 0;
        width: 100%;
    }

    .title {
        display: none; 
    }

    .report-header {
        display: block !important; 
        page-break-after: avoid; 
        margin-bottom: 30px; 
    }

    #results {
        margin-top: 0;
        display: block !important;
    }

    table {
        page-break-inside: auto;
        margin-top: 20px; 
    }

    tr, td, th {
        page-break-inside: avoid;
        page-break-after: auto;
    }

    .legacy-mode-toggle,
    #legacyMode,
    #saveAndExitBtn,
    .action-icons,
    .no-print {
        display: none !important;
    }
}

@media (max-width: 768px) {
    .container {
        width: 95%;
        padding: 1rem;
    }
    table {
        font-size: 0.9rem;
    }
    th, td {
        padding: 0.8rem;
    }
    input, select {
        padding: 0.8rem;
        font-size: 0.9rem;
    }
    .button-container {
        flex-direction: column;
    }
    .btn {
        width: 100%;
    }
    .title {
        font-size: 2rem;
        margin-top: 3rem;
    }
    .legacy-mode-toggle {
        top: 10px;
    }
}

.action-icons {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 20px;
}

.icon-wrapper {
    cursor: pointer;
    transition: var(--transition);
    padding: 10px;
    border-radius: 50%;
    background-color: #f0f0f0;
    position: relative;
}

.icon-wrapper:hover {
    transform: scale(1.1);
    background-color: #e0e0e0;
}

.icon-wrapper::after {
    content: attr(data-action);
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.3s ease;
    white-space: nowrap;
}

.icon-wrapper:hover::after {
    opacity: 1;
}

.print-icon svg {
    color: var(--secondary-color);
}

.submit-icon svg {
    color: var(--primary-color);
}

.icon-label {
    position: absolute;
    font-size: 14px;
    color: #4a90e2;
    font-weight: bold;
    white-space: nowrap;
}

.print-icon .icon-label {
    right: calc(100% + 10px);
    top: 50%;
    transform: translateY(-50%);
    color: #2ecc71;
}

.submit-icon .icon-label {
    left: calc(100% + 10px);
    top: 50%;
    transform: translateY(-50%);
}

.print-icon svg {
    color: #2ecc71; 
}

td[contenteditable="true"] {
    direction: ltr;
    text-align: left;
}

@page {
    @bottom-right {
        content: counter(page);
    }
}

body {
    counter-reset: page;
}

.page-break {
    page-break-after: always;
    counter-increment: page;
}

@media print {
    td[contenteditable="true"]::before {
        display: none;
    }
}

/* New improvements */

:root {
    --focus-ring: 0 0 0 3px rgba(74, 144, 226, 0.4);
}

.container {
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.title {
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

input, select, .btn {
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

input:focus, select:focus {
    box-shadow: var(--focus-ring);
}

.btn {
    position: relative;
    overflow: hidden;
}

.btn::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, .5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
}

@keyframes ripple {
    0% {
        transform: scale(0, 0);
        opacity: 1;
    }
    20% {
        transform: scale(25, 25);
        opacity: 1;
    }
    100% {
        opacity: 0;
        transform: scale(40, 40);
    }
}

.btn:focus:not(:active)::after {
    animation: ripple 1s ease-out;
}

table {
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
}

tr {
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

tr:hover {
    background-color: #f0f4f8;
}

.delete-btn {
    opacity: 0.7;
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.delete-btn:hover {
    opacity: 1;
}

.modal-content {
    animation: modalIn 0.3s ease-out;
}

.icon-wrapper {
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.icon-wrapper:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

@media (prefers-reduced-motion: reduce) {
    *, ::before, ::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
    }
}

.accessibility-focus:focus {
    outline: none;
    box-shadow: var(--focus-ring);
}

@media (hover: hover) {
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 7px 14px rgba(0,0,0,0.1), 0 3px 6px rgba(0,0,0,0.1);
    }
}

.btn:active {
    transform: translateY(1px);
}

.loading {
    position: relative;
    pointer-events: none;
}

.loading::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.7) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="%234a90e2" stroke-width="10" r="35" stroke-dasharray="164.93361431346415 56.97787143782138"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg>') center / 50px no-repeat;
}
    
</style>
</head>
<body>
    <div class="container">
        <h1 class="title">خارجي  طلاب</h1>
<div class="report-header print-only">
    <p>مرسل الي ادارة التموين الطبي والصيدليات</p>
    <p>فرع البحيرة المنطقة <span id="regionDisplay"></span></p>
    <p>صيدلية <span id="pharmacyDisplay"></span></p>
    <p>بيان الخارجي عن شهر <span id="monthDisplay"></span></p>
</div>
        <div class="legacy-mode-toggle">
            <span>Legacy Mode</span>
            <label class="toggle-switch">
                <input type="checkbox" id="legacyModeToggle" onchange="toggleLegacyMode()" title="Toggle Legacy Mode">
                <span class="slider"></span>
            </label>
        </div>
        <div class="no-print">
            <label for="regionSelect">المنطقة</label>
            <select id="regionSelect" title="Select Region" required>
                <option value="">المنطقة</option>
                <option value="first">الاولى</option>
                <option value="second">الثانية</option>
                <option value="third">الثالثة</option>
            </select>
            
            <label for="pharmacySelect">الصيدلية</label>
            <select id="pharmacySelect" disabled title="Select Pharmacy" required>
                <option value="">الصيدلية</option>
            </select>
            
            <label for="monthSelect">الشهر</label>
            <select id="monthSelect" title="Select Month" required>
                <option value="">الشهر</option>
                <option value="January">يناير</option>
                <option value="February">فبراير</option>
                <option value="March">مارس</option>
                <option value="April">ابريل</option>
                <option value="May">مايو</option>
                <option value="June">يونيو</option>
                <option value="July">يوليو</option>
                <option value="August">اغسطس</option>
                <option value="September">سبتمبر</option>
                <option value="October">اكتوبر</option>
                <option value="November">نوفمبر</option>
                <option value="December">ديسمبر</option>
            </select>
            
            <div class="autocomplete">
                <label for="searchInput">Search for a product</label>
                <input type="text" id="searchInput" placeholder="Search for a product..." title="Search for a product">
            </div>
            
            <label for="unitsSold">Units sold</label>
            <input type="number" id="unitsSold" placeholder="Units sold" step="1" min="0" title="Enter units sold">
            
            <div class="button-container">
                <button class="btn" onclick="addData()" title="Add Data">Add Data</button>
                <button class="btn" id="addNameBtn" onclick="showAddNameModal()" disabled title="Add Name">Add Name</button>
            </div>
        </div>
        <div id="results">
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Units Sold</th>
                        <th class="no-print"></th>
                    </tr>
                </thead>
                <tbody id="dataTable">
                </tbody>
            </table>
        </div>
        <div id="legacyMode">
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Units Sold</th>
                    </tr>
                </thead>
                <tbody id="legacyTable">
                </tbody>
            </table>
            <button id="saveAndExitBtn" onclick="saveAndExit()" title="Save and Exit">Save and Exit</button>
        </div>
<div class="action-icons no-print">
    <div class="icon-wrapper print-icon" onclick="printReport()" title="Print">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 6 2 18 2 18 9"></polyline>
            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
            <rect x="6" y="14" width="12" height="8"></rect>
        </svg>
        <span class="icon-label print-label">Print</span>
    </div>
    <div class="icon-wrapper submit-icon" onclick="submitData()" title="Submit">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
        </svg>
        <span class="icon-label submit-label">Submit</span>
    </div>
</div>

    <div id="addNameModal" class="modal">
        <div class="modal-content">
            <h2>Add New Name</h2>
            <label for="nameCategory">سبب الاضافة</label>
            <select id="nameCategory" title="Select reason for addition" required>
                <option value="">سبب الاضافة</option>
                <option value="قرار لجنة">قرار لجنة</option>
                <option value="حكم قضائي">حكم قضائي</option>
                <option value="داخل اللستة">داخل اللستة</option>
                <option value="شئون طبية">شئون طبية</option>
            </select>
            <label for="newProductName">Product Name</label>
            <input type="text" id="newProductName" placeholder="Product Name" title="Enter product name" required>
            <label for="newProductUnit">Product Unit</label>
            <input type="text" id="newProductUnit" placeholder="Product Unit (e.g., 10 T)" title="Enter product unit" required>
            <label for="newProductUnitsSold">Units Sold</label>
            <input type="number" id="newProductUnitsSold" placeholder="Units Sold" min="0" step="1" title="Enter units sold" required>
            <div class="button-container">
                <button class="btn" onclick="addNewName()">Add</button>
                <button class="btn" onclick="closeAddNameModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</body>
</html>
   <script>
    
    
const firebaseConfig = {
  apiKey: "AIzaSyCSqnxDsN3xLLXiOv7mDZKMsH1rIvWUXDM",
  authDomain: "plan-c-464c2.firebaseapp.com",
  databaseURL: "https://plan-c-464c2-default-rtdb.firebaseio.com",
  projectId: "plan-c-464c2",
  storageBucket: "plan-c-464c2.appspot.com",
  messagingSenderId: "326162245610",
  appId: "1:326162245610:web:9e0caefba12604cdb57493",
  measurementId: "G-MZ0WS41KWD"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
        
    const products = [
  "Abilify 15mg (حكم قضائي)|10 T",
  "Acetylcysteine 300mg|Amp",
  "Acetylcysteine Sachets|10 Sach",
  "Acetylsalicylic Acid 75mg|10 T",
  "Acyclovir 400mg|10 T",
  "Aescin gel|Tube",
  "Allopurinol 100mg|10 T",
  "Alpha Lipoic Acid 300mg|10 T",
  "Alpha Lipoic Acid 600mg|10 T",
  "Amiloride 5mg & HCT 50mg|10 T",
  "Amoxicillin & Clavulanic acid 457mg|B",
  "Antacid Syp|B",
  "Antibiotic & Corticosteroid cream|Tube",
  "Apixaban 2.5mg|10 T",
  "Apixaban 5mg|10 T",
  "Aranesp 100mcg|Syringe",
  "Aranesp 30mcg (حكم قضائي)|Syringe",
  "Aripiprex (حكم قضائي)|B",
  "Artamine 300mg|10 T",
  "Atomoxetine 40mg|10 T",
  "Atomoxetine 60mg|10 T",
  "Atomoxetine Syp|B",
  "Azathioprine 50mg|10 T",
  "Azithromycin Syp|B",
  "Beclomethasone & Salbutamol Inhalation|B",
  "Beclomethasone spray|B",
  "Betamethasone & Salicylic Acid Lotion|B",
  "Betamethasone Cream|Tube",
  "Bilichol|12 Cap",
  "Bosentan 62.5mg|10 T",
  "Brivaracetam 50mg ( لجنه عليا)|10 T",
  "Bronchicum (حكم محكمة)|B",
  "Budesonide 160mcg & Formoterol 4.5mcg|B",
  "Calcium|10 Cap",
  "Calcium Syp|B",
  "Carbamazipine CR 400 mg|10 T",
  "Carbimazole|10 T",
  "Carbmazepine Syrup|B",
  "Carvedilol 6.25mg|10 T",
  "Celecoxib 200mg|10 T",
  "Cholecalciferol 10000IU|10 T",
  "Cholecalciferol 2800IU Drops|B",
  "Cholestyramine Sachets|Sach",
  "Citicoline Syp|B",
  "Clarithromycin 500mg|14 Cap",
  "Clobetasol Cream|Tube",
  "Clonazepam 0.5mg|10 T",
  "Clotrimazole Cream|Tube",
  "CNS Muscle Relaxant|10 T",
  "Colchicine 0.5mg|10 T",
  "Concerta 36mg (حكم قضائي)|30 T",
  "Creon 25000|100 T",
  "Cyclophosphamide 1g|Vial",
  "Cyclosporin 100mg|10 T",
  "Cyclosporin 50mg|10 T",
  "Cyclosporin Syrup|B",
  "Cytarabine 1g|Vial",
  "Deferiprone 500mg|50 T",
  "Deferoxamine 500mg|Vial",
  "Diflucan 50mg (لجنة عليا)|1 Cap",
  "Digoxine 0.25mg|10 T",
  "Dorzolamide & Timolol E.dp|B",
  "Doxazosin 1mg|10 T",
  "Doxazosin 4 mg|10 T",
  "Dydrogesterone 10mg|20 T",
  "Efalex Syp (حكم قضائي)|B",
  "Efamol Syp (حكم قضائي)|B",
  "Endoxan 50mg|50 T",
  "Enoxaparin 40mg|Syringe",
  "Enoxaparin 60mg|Syringe",
  "Epifasi 5000 IU (Human Chorionc Gonadotropin)|Amp",
  "Estradiol & Norgestrel|21 T",
  "Etoposide 100mg|Vial",
  "Everolimus 0.25mg|10 T",
  "Everolimus 0.75mg|10 T",
  "Flixotide 125mcg Inhaler (حكم قضائي)|B",
  "Fluconazole 150mg|1 Cap",
  "Fluimucil 300mg (قرار لجنة)|Amp",
  "Fluoxetine 20mg|10 T",
  "Fluticasone 125mcg & Salmeterol 25mcg|B",
  "Fucidic Acid|Tube",
  "Gabapentin 100mg|10 T",
  "Gabapentin 400mg|10 T",
  "Gastrobiotic 550mg (لجنه عليا)|10 T",
  "Gentamicin 80mg|Amp",
  "Gentamicin Cream|Tube",
  "Ginko biloba 40mg|10 T",
  "Gliclazide MR 60mg|10 T",
  "Glimepiride 1mg|10 T",
  "Glimepiride 2mg|10 T",
  "Haloperidol 5mg|10 T",
  "Hydroxychloroquine|10 T",
  "Hydroxyurea 500mg|10 T",
  "Imipramine 25mg|10 T",
  "Insulin isophane protamine|Penfill",
  "Insulin Lispro 100IU|Penfill",
  "Insulin Neutral Human|Penfill",
  "Ipratropium & Salbutamol|Amp",
  "Iron|10 T",
  "Iron syrp|B",
  "Iruxole Oint. (استثناء مكتب مدير الفرع)|Tube",
  "Ivabradine 5mg|10 T",
  "Ketosteril|10 T",
  "Ketotifen Syp|B",
  "Lacosamide 100mg|10 T",
  "Lacosamide 50mg|10 T",
  "Lacosamide Syp|B",
  "Lacovimp 50mg (حكم قضائي)|10 T",
  "Lactulose Syp|B",
  "Lamictal 100mg (حكم قضائي)|30 T",
  "Lamotrigine 100mg|10 T",
  "Lamotrigine 25mg|10 T",
  "Lamotrigine 50mg|10 T",
  "Latanoprost dp|B",
  "Levemir (حكم قضائي)|Pen",
  "Levetiracetam 1000mg|10 T",
  "Levetiracetam 500mg|10 T",
  "Levetiracetam 750mg (حكم قضائي)|10 T",
  "Levetiracetam Syp|B",
  "Levodopa 250mg & Carbidopa 25mg|10 T",
  "Levothyroxine 100mcg|100 T",
  "Levothyroxine 50mcg|100 T",
  "Long Acting Penicillin|Vial",
  "Magnesium Citrate eff.|12 Sach",
  "Mebeverine 100mg & Sulpiride 25mg|10 T",
  "Meclofenoxate 500mg|20 T",
  "Memantine 10mg|10 T",
  "Memantine drops|B",
  "Memexa dp. (حكم قضائي)|B",
  "Mesalazine 500mg|10 T",
  "Methotrexate|Vial",
  "Methotrexate 2.5mg|10 T",
  "Methylcobalamine|Amp",
  "Metronidazole 250mg|10 T",
  "Metronidazole Syp|B",
  "Montelukast 10 mg|10 T",
  "Montelukast 4mg Sachets|10 Sach",
  "Multivitamins Syp|B",
  "Naftidrofuryl|10 T",
  "Nasonex (حكم قضائي)|B",
  "Nebivolol 5mg|10 T",
  "Neocate Milk (حكم قضائي)|B",
  "Nexium 20mg (حكم قضائي)|7 T",
  "Novorapid (حكم قضائي)|Penfill",
  "N-plate 250mcg|Vial",
  "Nystatin dps|B",
  "Omega 3|10 Cap",
  "Omeprazole 20mg|7 T",
  "Omeprazole 40mg|10 Cap",
  "Omnitrope 10mg/1.5ml|Penfill",
  "Oxcarbazepine 300mg|10 T",
  "Oxcarbazepine Syp|B",
  "Oxybutynin 5mg|10 T",
  "Panthenol cream|Tube",
  "Pentasa 500mg (لجنة عليا)|10 T",
  "Pentoxifylline 400mg|10 T",
  "Phenytoin 50mg|10 T",
  "Phenytoin Syp|B",
  "Piracetam 400mg|10 T",
  "Piracetam Syp|B",
  "Potassium Syp|B",
  "Povidone Iodine Shampoo|B",
  "Prednisolone 20mg|10 T",
  "Prednisolone 5mg|10 T",
  "Prograf 1mg|100 T",
  "Propranolol 40mg|10 T",
  "Pyridostigmin 60mg|10 T",
  "Quetiapine 100mg|10 T",
  "Rebamipide 20mg|10 T",
  "Rebif 44mcg (قرار لجنة)|Syringe",
  "Risperdal (حكم قضائي)|B",
  "Risperidone 1mg|10 T",
  "Risperidone Syp|B",
  "Rivaroxaban 15mg|10 T",
  "Rivaroxban 2.5mg|10 T",
  "Salbutamol Inhaler|B",
  "Sandostatin LAR (قرار لجنة)|Syringe",
  "Sertraline 50mg|10 T",
  "Sirolimus 1gm|10 T",
  "Sodium Valproate 200mg|10 T",
  "Sodium Valproate 500mg|10 T",
  "Sodium Bicarbonate (لجنة عليا)|Amp",
  "Solifenacin 10mg|10 T",
  "Somatropine|Vial",
  "Somazina dp. (حكم قضائي)|B",
  "Spiramycin 1.5 MIU|10 T",
  "Spironolactone 100 mg|10 T",
  "Spironolactone 25 mg|10 T",
  "Stimulan Syp (حكم قضائي)|B",
  "Strattera 60mg (حكم قضائي)|28 T",
  "Sulphamethoxazole & Trimethoprim|B",
  "Sulphasalazine|10 T",
  "Tacrolimus 0.5mg|10 T",
  "Tenofovir 300mg|30 T",
  "Thrombonorm 0.5mg (لجنة عليا)|10 Cap",
  "Tiralepsy Syp (قرار لجنة)|B",
  "Tiratam 1000mg (حكم قضائي)|30 T",
  "Tiratam Syp (حكم قضائي)|B",
  "Tiratam Syp (قرار لجنة)|B",
  "Tobramycin Amp|Amp",
  "Topiramate 100mg|10 T",
  "Topiramate 25mg|10 T",
  "Tranexamic Acid 500mg|10 T",
  "Tresiba (حكم قضائي)|Pen",
  "Trileptal 600mg (حكم قضائي)|50 T",
  "Trileptal Syp (حكم قضائي)|B",
  "Trimebutine 200mg|10 T",
  "Umatone Brain (حكم قضائي)|30 Sach",
  "Uptravi 400mcg|60 T",
  "Ursodeoxycholic acid 250mg|10 Cap",
  "Valganciclovir 450mg (لجنة)|60 T",
  "Valproic Acid Syrup|B",
  "Verapamil 240mg|10 T",
  "Vildagliptin 50mg|10 T",
  "Vildagliptin 50mg & Metformin 850mg|10 T",
  "Vitamin A|10 T",
  "Vitamin B Comp.|10 T",
  "Vitamin B Syrup|B",
  "Voriconazole 200mg|10 T",
  "Voriconazole 200mg Vial|Vial",
  "Warfarin 3mg|10 T",
  "Warfarin 5 mg|10 T",
  "Xarelto 10mg (حكم قضائى)|10 T",
  "Zinc Syp|B",
  "Zithromax 250mg (حكم قضائي)|6 Cap",
  "Zoledronic Acid 4mg|Vial"
].sort();

    const regionOptions = {
        first: ["كفر الدوار طلاب", "البيضا طلاب", "ابو المطامير طلاب", "رشيد طلاب", "ادكو طلاب"],
        second: ["دمنهور طلاب", "حوش عيسي طلاب", "المحمودية طلاب", "الرحمانية طلاب ", "ابو حمص طلاب","اورام طلاب"],
        third: ["ايتاي طلاب", "كوم حمادة طلاب", "بدر طلاب", "شبراخيت طلاب", "الدلنجات طلاب"]
    };

    let data = [];
    let selectedProducts = new Set();
    let isLegacyMode = false;
    let currentLegacyCell = null;

function autocomplete(inp, arr) {
    let currentFocus;
    inp.addEventListener("input", function(e) {
        let a, b, i, val = this.value;
        closeAllLists();
        if (!val) { return false; }
        currentFocus = -1;
        a = document.createElement("DIV");
        a.setAttribute("id", this.id + "autocomplete-list");
        a.setAttribute("class", "autocomplete-items");
        this.parentNode.appendChild(a);
    for (i = 0; i < arr.length; i++) {
        if (arr[i].toLowerCase().includes(val.toLowerCase())) {
            b = document.createElement("DIV");
            let [name, unit] = arr[i].split('|');
            b.innerHTML = `<span class="product-name">${name}</span> <span class="product-unit">${unit}</span>`;
            b.innerHTML += `<input type='hidden' value='${arr[i]}'>`;
            if (selectedProducts.has(arr[i])) {
                b.classList.add("highlighted");
            }
            if (isDuplicate(arr[i])) {
                b.classList.add("already-in-table");
            }
            b.addEventListener("click", function(e) {
                inp.value = this.getElementsByTagName("input")[0].value;
                closeAllLists();
            });
            a.appendChild(b);
        }
    }
    
    });
    
    inp.addEventListener("keydown", function(e) {
        let x = document.getElementById(this.id + "autocomplete-list");
        if (x) x = x.getElementsByTagName("div");
        if (e.keyCode == 40) {
            currentFocus++;
            addActive(x);
        } else if (e.keyCode == 38) {
            currentFocus--;
            addActive(x);
        } else if (e.keyCode == 13) {
            e.preventDefault();
            if (currentFocus > -1) {
                if (x) x[currentFocus].click();
            }
        }
    });
    
    function addActive(x) {
        if (!x) return false;
        removeActive(x);
        if (currentFocus >= x.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (x.length - 1);
        x[currentFocus].classList.add("autocomplete-active");
    }
    
    function removeActive(x) {
        for (let i = 0; i < x.length; i++) {
            x[i].classList.remove("autocomplete-active");
        }
    }
    
    function closeAllLists(elmnt) {
        let x = document.getElementsByClassName("autocomplete-items");
        for (let i = 0; i < x.length; i++) {
            if (elmnt != x[i] && elmnt != inp) {
                x[i].parentNode.removeChild(x[i]);
            }
        }
    }
    
    document.addEventListener("click", function(e) {
        closeAllLists(e.target);
    });
}

    autocomplete(document.getElementById("searchInput"), products);

    document.getElementById("regionSelect").addEventListener("change", function() {
        const region = this.value;
        const pharmacySelect = document.getElementById("pharmacySelect");
        pharmacySelect.innerHTML = '<option value="">الصيدلية</option>';
        if (regionOptions[region]) {
            regionOptions[region].forEach(pharmacy => {
                const option = document.createElement("option");
                option.value = pharmacy;
                option.textContent = pharmacy;
                pharmacySelect.appendChild(option);
            });
            pharmacySelect.disabled = false;
        } else {
            pharmacySelect.disabled = true;
        }
        updateAllRows();
        saveData();
        updateLegacyModeVisibility();
        updateAddNameButtonState();
        updateHeaderInfo();
    });

    document.getElementById("pharmacySelect").addEventListener("change", function() {
        updateAllRows();
        saveData();
        updateLegacyModeVisibility();
        updateAddNameButtonState();
        updateHeaderInfo();
    });

    document.getElementById("monthSelect").addEventListener("change", function() {
        updateAllRows();
        saveData();
        updateLegacyModeVisibility();
        updateAddNameButtonState();
        updateHeaderInfo();
    });
    
document.getElementById('dataTable').addEventListener('input', function(e) {
    if (e.target.tagName === 'TD' && e.target.getAttribute('contenteditable') === 'true') {
        const cursorPosition = window.getSelection().getRangeAt(0).startOffset;
        e.target.textContent = e.target.textContent.replace(/[^0-9]/g, '');
        
        const range = document.createRange();
        const sel = window.getSelection();
        
        if (e.target.childNodes.length > 0) {
            range.setStart(e.target.childNodes[0], Math.min(cursorPosition, e.target.textContent.length));
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }
});

function addData(product, unitsSold) {
    const month = document.getElementById("monthSelect").value;
    const region = document.getElementById("regionSelect").value;
    const pharmacy = document.getElementById("pharmacySelect").value;

    if (!isLegacyMode) {
        product = document.getElementById("searchInput").value;
        unitsSold = document.getElementById("unitsSold").value;
    }

    if (!product || !unitsSold || !month || !region || !pharmacy) {
        if (isLegacyMode) {
            return;
        } else {
            alert("Please fill in all fields");
            return;
        }
    }

    unitsSold = parseInt(unitsSold);
    if (isNaN(unitsSold) || unitsSold < 0 || !Number.isInteger(unitsSold)) {
        if (isLegacyMode) {
            return; 
        } else {
            alert("Please enter a valid number.");
            return;
        }
    }

    if (isLegacyMode && !products.includes(product)) {
        return;
    }

    if (!isLegacyMode) {
        const validProduct = products.find(p => p === product);
        if (!validProduct) {
            alert("Please select a valid product from the list");
            return;
        }
        product = validProduct;
    }

    const method = isLegacyMode ? 'old' : (products.includes(product) ? 'old' : 'new');

    const existingEntry = data.find(entry => entry.product === product);
    if (existingEntry) {
        existingEntry.unitsSold = unitsSold;
    } else {
        data.push({ product, unitsSold, month, region, pharmacy, method });
    }

    updateTable();
    if (!isLegacyMode) {
        resetSelections();
    }
    saveData();
}


function updateTable() {
    const table = document.getElementById("dataTable");
    table.innerHTML = '';
    data.sort((a, b) => a.product.localeCompare(b.product)).forEach((entry, index) => {
        const row = document.createElement("tr");
        const [name, unit] = entry.product.split('|');
        row.innerHTML = `
            <td><span class="product-name">${name}</span> <span class="product-unit">${unit}</span>${entry.needsApproval ? ' <span style="color: red;">(new)</span>' : ''}</td>
            <td contenteditable="true" onblur="updateUnitsSold(${index}, this)">${entry.unitsSold}</td>
            <td class="no-print">
                <button class="delete-btn" onclick="deleteRow(${index})" title="Delete">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </button>
            </td>
        `;
        table.appendChild(row);
    });
    updateLegacyTable();
}

    function deleteRow(index) {
        const entry = data[index];
        selectedProducts.delete(entry.product);
        data.splice(index, 1);
        updateTable();
        saveData();
    }

    function updateUnitsSold(index, element) {
        const newValue = parseInt(element.textContent);
        if (isNaN(newValue) || newValue < 0) {
            alert("Please enter a valid number.");
            element.textContent = data[index].unitsSold;
        } else {
            data[index].unitsSold = newValue;
        }
        updateLegacyTable();
        saveData();
    }

    function updateAllRows() {
        const region = document.getElementById("regionSelect").value;
        const pharmacy = document.getElementById("pharmacySelect").value;
        const month = document.getElementById("monthSelect").value;

        if (region && pharmacy && month) {
            data.forEach(entry => {
                entry.region = region;
                entry.pharmacy = pharmacy;
                entry.month = month;
            });
            updateTable();
        }
    }

function isDuplicate(product) {
    return data.some(entry => entry.product === product);
}

    function resetSelections() {
        document.getElementById("searchInput").value = '';
        document.getElementById("unitsSold").value = '';
    }

    function toggleLegacyMode() {
        const region = document.getElementById("regionSelect").value;
        const pharmacy = document.getElementById("pharmacySelect").value;
        const month = document.getElementById("monthSelect").value;

        if (!region || !pharmacy || !month) {
            alert("Please fill in Region, Pharmacy, and Month before entering Legacy Mode.");
            document.getElementById("legacyModeToggle").checked = false;
            return;
        }

        isLegacyMode = !isLegacyMode;
        updateLegacyModeVisibility();
    }

function updateLegacyModeVisibility() {
    const region = document.getElementById("regionSelect").value;
    const pharmacy = document.getElementById("pharmacySelect").value;
    const month = document.getElementById("monthSelect").value;
    const allFieldsFilled = region && pharmacy && month;

    document.getElementById("results").style.display = isLegacyMode && allFieldsFilled ? "none" : "block";
    document.getElementById("legacyMode").style.display = isLegacyMode && allFieldsFilled ? "block" : "none";
    
    document.getElementById("regionSelect").disabled = isLegacyMode && allFieldsFilled;
    document.getElementById("pharmacySelect").disabled = isLegacyMode && allFieldsFilled;
    document.getElementById("monthSelect").disabled = isLegacyMode && allFieldsFilled;

    document.getElementById("saveAndExitBtn").style.display = isLegacyMode && allFieldsFilled ? "block" : "none";

    if (!allFieldsFilled) {
        isLegacyMode = false;
        document.getElementById("legacyModeToggle").checked = false;
    }
}

function updateLegacyTable() {
    const legacyTable = document.getElementById("legacyTable");
    legacyTable.innerHTML = '';
    products.forEach((product, index) => {
        const row = document.createElement("tr");
        const [name, unit] = product.split('|');
        const entry = data.find(e => e.product === product);
        row.innerHTML = `
            <td><span class="product-name">${name}</span> <span class="product-unit">${unit}</span></td>
            <td contenteditable="true" data-product="${product}" data-index="${index}">${entry ? entry.unitsSold : ''}</td>
        `;
        legacyTable.appendChild(row);
    });
}

function updateLegacyUnitsSold(product, element) {
    const newValue = parseInt(element.textContent);
    if (isNaN(newValue) || newValue < 0) {
        element.textContent = '';
        return;
    }

    addData(product, newValue);
}

    document.getElementById('legacyTable').addEventListener('focus', function(e) {
        if (e.target.tagName === 'TD' && e.target.getAttribute('contenteditable') === 'true') {
            currentLegacyCell = e.target;
            highlightRow(e.target.closest('tr'));
        }
    }, true);

    document.getElementById('legacyTable').addEventListener('blur', function(e) {
        if (e.target.tagName === 'TD' && e.target.getAttribute('contenteditable') === 'true') {
            unhighlightRow(e.target.closest('tr'));
            updateLegacyUnitsSold(e.target.dataset.product, e.target);
        }
    }, true);

document.getElementById('legacyTable').addEventListener('input', function(e) {
    if (e.target.tagName === 'TD' && e.target.getAttribute('contenteditable') === 'true') {
        const cursorPosition = window.getSelection().getRangeAt(0).startOffset;
        e.target.textContent = e.target.textContent.replace(/[^0-9]/g, '');
        
        const range = document.createRange();
        const sel = window.getSelection();
        
        if (e.target.childNodes.length > 0) {
            range.setStart(e.target.childNodes[0], Math.min(cursorPosition, e.target.textContent.length));
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }
});

    document.getElementById('legacyTable').addEventListener('keydown', function(e) {
        if (!isLegacyMode || !currentLegacyCell) return;

        const currentRow = currentLegacyCell.closest('tr');
        const currentIndex = Array.from(currentRow.parentNode.children).indexOf(currentRow);
        const totalRows = currentRow.parentNode.children.length;

        switch (e.key) {
            case 'ArrowUp':
                e.preventDefault();
                if (currentIndex > 0) {
                    updateLegacyUnitsSold(currentLegacyCell.dataset.product, currentLegacyCell);
                    navigateToCell(currentIndex - 1);
                }
                break;
            case 'ArrowDown':
            case 'Enter':
                e.preventDefault();
                updateLegacyUnitsSold(currentLegacyCell.dataset.product, currentLegacyCell);
                if (currentIndex < totalRows - 1) {
                    navigateToCell(currentIndex + 1);
                }
                break;
        }
    });

    function navigateToCell(index) {
        const targetRow = document.getElementById('legacyTable').rows[index];
        const targetCell = targetRow.querySelector('td[contenteditable="true"]');
        targetCell.focus();
        highlightRow(targetRow);
        currentLegacyCell = targetCell;
    }

    function highlightRow(row) {
        unhighlightAllRows();
        row.classList.add('selected-row');
    }

    function unhighlightRow(row) {
        row.classList.remove('selected-row');
    }

    function unhighlightAllRows() {
        const rows = document.querySelectorAll('#legacyTable tr');
        rows.forEach(row => unhighlightRow(row));
    }

function saveData() {
    localStorage.setItem('pharmacyData', JSON.stringify(data));
    localStorage.setItem('selectedRegion', document.getElementById("regionSelect").value);
    localStorage.setItem('selectedPharmacy', document.getElementById("pharmacySelect").value);
    localStorage.setItem('selectedMonth', document.getElementById("monthSelect").value);
    localStorage.setItem('products', JSON.stringify(products));
}

function loadData() {
    const savedData = localStorage.getItem('pharmacyData');
    if (savedData) {
        data = JSON.parse(savedData);
        updateTable();
    }

    const savedRegion = localStorage.getItem('selectedRegion');
    if (savedRegion) {
        document.getElementById("regionSelect").value = savedRegion;
        document.getElementById("regionSelect").dispatchEvent(new Event('change'));
    }

    const savedPharmacy = localStorage.getItem('selectedPharmacy');
    if (savedPharmacy) {
        document.getElementById("pharmacySelect").value = savedPharmacy;
    }

    const savedMonth = localStorage.getItem('selectedMonth');
    if (savedMonth) {
        document.getElementById("monthSelect").value = savedMonth;
    }

    const savedProducts = localStorage.getItem('products');
    if (savedProducts) {
        products = JSON.parse(savedProducts);
    }

    document.getElementById("saveAndQuitBtn").textContent = "Save and Exit";
    document.getElementById("saveAndQuitBtn").setAttribute("onclick", "saveAndExit()");

    updateLegacyModeVisibility();
    updateAddNameButtonState();
    updateHeaderInfo();

}

function saveAndExit() {
    saveData();
    isLegacyMode = false;
    document.getElementById("legacyModeToggle").checked = false;
    updateLegacyModeVisibility();
    document.getElementById("legacyMode").style.display = "none";
    document.getElementById("results").style.display = "block";
    
}

    function updateAddNameButtonState() {
        const region = document.getElementById("regionSelect").value;
        const pharmacy = document.getElementById("pharmacySelect").value;
        const month = document.getElementById("monthSelect").value;
        const addNameBtn = document.getElementById("addNameBtn");

        addNameBtn.disabled = !(region && pharmacy && month);
    }

    function showAddNameModal() {
        document.getElementById("addNameModal").style.display = "block";
    }

function closeAddNameModal() {
    document.getElementById("addNameModal").style.display = "none";
    document.getElementById("nameCategory").value = "";
    document.getElementById("newProductName").value = "";
    document.getElementById("newProductUnit").value = "";
    document.getElementById("newProductUnitsSold").value = "";
}

function addNewName() {
    const category = document.getElementById("nameCategory").value;
    const name = document.getElementById("newProductName").value;
    const unit = document.getElementById("newProductUnit").value;
    const unitsSold = document.getElementById("newProductUnitsSold").value;

    if (!category || !name || !unit || !unitsSold) {
        alert("Please fill in all fields");
        return;
    }

    if (isNaN(unitsSold) || parseInt(unitsSold) < 0 || !Number.isInteger(parseFloat(unitsSold))) {
        alert("Please enter a valid number for Units Sold");
        return;
    }

    let fullName = name;
    if (category !== "داخل اللستة") {
        fullName += ` (${category})`;
    }

    const newProduct = `${fullName}|${unit}`;

    data.push({
        product: newProduct,
        unitsSold: parseInt(unitsSold),
        month: document.getElementById("monthSelect").value,
        region: document.getElementById("regionSelect").value,
        pharmacy: document.getElementById("pharmacySelect").value,
        method: 'new'
    });

    saveData();
    updateTable();
    closeAddNameModal();
    alert("Added.");
}

function handleNumericInput(event) {
    const cell = event.target;
    if (cell.tagName === 'TD' && cell.getAttribute('contenteditable') === 'true') {
        const cursorPosition = window.getSelection().getRangeAt(0).startOffset;
        const originalLength = cell.textContent.length;
        
        cell.textContent = cell.textContent.replace(/[^0-9]/g, '');
        
        const newLength = cell.textContent.length;
        
        const newPosition = Math.max(0, cursorPosition - (originalLength - newLength));
        
        const range = document.createRange();
        const sel = window.getSelection();
        
        if (cell.childNodes.length > 0) {
            range.setStart(cell.childNodes[0], newPosition);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }
}

function updateHeaderInfo() {
    const region = document.getElementById("regionSelect").value;
    const pharmacy = document.getElementById("pharmacySelect").value;
    const month = document.getElementById("monthSelect").value;

    const regionMap = {
        "first": "الاولى",
        "second": "الثانية",
        "third": "الثالثة"
    };

    const monthMap = {
        "January": "يناير",
        "February": "فبراير",
        "March": "مارس",
        "April": "ابريل",
        "May": "مايو",
        "June": "يونيو",
        "July": "يوليو",
        "August": "اغسطس",
        "September": "سبتمبر",
        "October": "اكتوبر",
        "November": "نوفمبر",
        "December": "ديسمبر"
    };

    document.getElementById("regionDisplay").textContent = regionMap[region] || "";
    document.getElementById("pharmacyDisplay").textContent = pharmacy || "";
    document.getElementById("monthDisplay").textContent = monthMap[month] || "";
}

function printReport() {
    updateHeaderInfo(); 
    window.print();
}


let isSubmitting = false;

function submitData() {
    if (isSubmitting) {
        alert("Submission is already in progress. Please wait.");
        return;
    }
    if (confirm("Are you sure you want to submit the data?")) {
        if (data.length === 0) {
            alert("There is nothing to submit. Please add some data first.");
            return;
        }
        const month = document.getElementById("monthSelect").value;
        const region = document.getElementById("regionSelect").value;
        const pharmacy = document.getElementById("pharmacySelect").value;
        if (!month || !region || !pharmacy) {
            alert("Please select a valid month, region, and pharmacy before submitting.");
            return;
        }
        if (!["first", "second", "third"].includes(region)) {
            alert("Please select a valid region.");
            return;
        }
        if (!regionOptions[region].includes(pharmacy)) {
            alert("Please select a valid pharmacy for the chosen region.");
            return;
        }
        const validMonths = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        if (!validMonths.includes(month)) {
            alert("Please select a valid month.");
            return;
        }
        isSubmitting = true;

        const submissionData = data.map(item => {
            const [name, unit] = item.product.split('|');
            return {
                month: month,
                region: region,
                pharmacy: pharmacy,
                name: name,
                unit: unit,
                unitSold: item.unitsSold,
                method: item.method,
                timestamp: new Date().toISOString()
            };
        });

        const jsonData = JSON.stringify(submissionData, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pharmacy_data_${month}_${region}_${pharmacy}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        const pharmacyRef = database.ref('pharmacyData');
        pharmacyRef.push(submissionData)
        .then(() => {
            alert('Data submitted successfully!');
            data = [];
            updateTable();
            saveData();
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('There was an error submitting the data. Please try again.');
        })
        .finally(() => {
            isSubmitting = false;
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadData();
});

    setInterval(saveData, 30000);

    updateLegacyTable();

    </script>
</body>
</html>