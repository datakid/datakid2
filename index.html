<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيان الخارجي</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
:root {
    --primary-color: #0A6C7E; 
    --primary-light: #2BA0B5; 
    --primary-dark: #065A6A; 
    --secondary-color: #0D9488; 
    --secondary-light: #81E6D9; 
    --text-color: #1A202C; 
    --text-light: #4A5568;
    --background-color: #F0F9FA; 
    --card-color: #FFFFFF;
    --hover-color: #D1FAFA; 
    --enhanced-hover-color: #A8F0F0; 
    --error-color: #E53E3E;
    --success-color: #38A169; 
    --border-color-subtle: rgba(13, 148, 136, 0.15);
    --border-radius: 12px;
    --border-radius-lg: 16px;
    --border-radius-sm: 8px;
    
    --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.07);
    --shadow-md: 0 4px 8px rgba(0,0,0,0.06), 0 2px 6px rgba(0,0,0,0.04);
    --shadow-lg: 0 10px 20px rgba(11,114,133,0.07), 0 3px 8px rgba(11,114,133,0.05);
    --shadow-xl: 0 20px 30px rgba(11,114,133,0.09), 0 5px 15px rgba(11,114,133,0.06);
    
    --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-bounce: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    --transition-elegant: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}

body {
    font-family: 'Roboto', 'Cairo', sans-serif; 
    margin: 0;
    padding: 20px;
    background-color: var(--background-color);
    color: var(--text-color);
    line-height: 1.7;
    background-image: 
        radial-gradient(circle at 10% 20%, rgba(13, 148, 136, 0.04), transparent 50%),
        radial-gradient(circle at 90% 80%, rgba(10, 108, 126, 0.04), transparent 50%),
        linear-gradient(135deg, rgba(240,249,250,1) 0%, rgba(209,250,250,0.3) 100%);
    background-attachment: fixed;
}

.card {
    background-color: rgba(255, 255, 255, 0.88);
    backdrop-filter: blur(14px) saturate(150%);
    -webkit-backdrop-filter: blur(14px) saturate(150%);
    border-radius: var(--border-radius-lg);
    padding: 32px;
    box-shadow: var(--shadow-lg);
    margin-bottom: 28px;
    transition: var(--transition-elegant);
    width: 100%;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
    border: 1px solid rgba(142,234,234,0.25); 
    position: relative;
    overflow: hidden;
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 0%;
    height: 5px;
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    transition: var(--transition-smooth);
}

.card:hover {
    box-shadow: var(--shadow-xl);
    transform: translateY(-4px);
}

.card:hover::before {
    width: 100%;
}

.hidden {
    display: none !important;
}

button {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
    color: white;
    border: none;
    padding: 14px 28px;
    margin: 10px 5px;
    border-radius: 50px; 
    font-size: 15px;
    font-weight: 700; 
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: var(--transition-bounce);
    box-shadow: var(--shadow-md);
    position: relative;
    overflow: hidden;
    z-index: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-family: 'Roboto', sans-serif; 
}
button .material-icons {
    margin-right: 8px;
    font-size: 20px;
}
button#backBtn {
    margin: 0;
}
button#backBtn .material-icons { margin-right: 8px; margin-left: -4px;} 
button#submitBtn .material-icons { margin-right: 10px; }

button::after { 
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255,255,255,0.3);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%, -50%);
    transform-origin: 50% 50%;
}

button:hover {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
    box-shadow: var(--shadow-lg);
    transform: translateY(-3px) scale(1.03);
}

button:active::after {
    animation: ripple 0.6s ease-out;
}

button:active {
    transform: translateY(0px) scale(1);
    box-shadow: var(--shadow-sm);
}

@keyframes ripple {
    0% { transform: scale(0, 0) translate(-50%, -50%); opacity: 1; }
    100% { transform: scale(40, 40) translate(-50%, -50%); opacity: 0; }
}

select, input[type="text"], input[type="number"] {
    width: 100%;
    padding: 16px 20px;
    margin: 12px 0;
    border: 2px solid var(--border-color-subtle);
    border-radius: var(--border-radius);
    font-size: 16px;
    font-family: 'Roboto', 'Cairo', sans-serif;
    transition: var(--transition-smooth);
    background-color: #FDFEFF;
    box-sizing: border-box;
    box-shadow: var(--shadow-xs) inset;
    color: var(--text-color);
}

select:focus, input[type="text"]:focus, input[type="number"]:focus {
    outline: none;
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 4px var(--secondary-light), 0 4px 6px rgba(0,0,0,0.05);
    transform: translateY(-1px) scale(1.01);
    background-color: white;
}

select:required:invalid,
input[type="number"]:required:invalid {
    border-color: var(--error-color) !important;
    background-color: #FFF5F5 !important;
    animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
}
input:placeholder-shown {
    color: #A0AEC0;
}

@keyframes shake {
    10%, 90% { transform: translate3d(-1px, 0, 0); }
    20%, 80% { transform: translate3d(2px, 0, 0); }
    30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
    40%, 60% { transform: translate3d(3px, 0, 0); }
}

select option[value=""][disabled] {
    display: none;
}

select option {
    color: var(--text-color);
    background-color: white;
    padding: 10px;
    font-family: 'Roboto', 'Cairo', sans-serif; 
}

#searchBar {
    font-size: 18px;
    width: 100%;
    margin-bottom: 12px;
    padding: 18px 24px;
    border: 3px solid var(--primary-color);
    border-radius: 50px;
    transition: var(--transition-elegant);
    background-color: white;
    box-shadow: var(--shadow-md);
    box-sizing: border-box;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%230B7285' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 20px center;
    padding-right: 50px; 
}

#searchBar:focus {
    border-color: var(--secondary-color);
    box-shadow: var(--shadow-xl), 0 0 0 5px var(--secondary-light);
    outline: none;
    transform: scale(1.02);
}

#suggestions, #didYouMean {
    background-color: var(--card-color);
    border: 1px solid var(--primary-light);
    border-radius: var(--border-radius);
    max-height: 250px;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    margin-top: 8px;
    transform-origin: top center;
    animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-light) var(--background-color);
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-15px) scaleY(0.95); }
    to { opacity: 1; transform: translateY(0) scaleY(1); }
}

#suggestions div, #didYouMean div {
    padding: 16px 24px;
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s, transform 0.2s;
    border-bottom: 1px solid rgba(142,234,234,0.3);
    font-family: 'Roboto', 'Cairo', sans-serif;
}
#suggestions div:last-child, #didYouMean div:last-child {
    border-bottom: none;
}

#suggestions div:hover, #didYouMean div:hover {
    background-color: var(--enhanced-hover-color);
    color: var(--primary-dark);
    transform: translateX(5px);
}
#didYouMean div { font-style: italic; color: var(--text-light); }
#didYouMean div:first-child { font-style: normal; font-weight: 500; color: var(--text-color); background-color: transparent !important; cursor: default; transform: none !important;}

.title-container {
    text-align: center;
    margin-bottom: 35px;
    padding: 40px 20px;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-xl);
    position: relative;
    overflow: hidden;
}

.title-container::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background-image: conic-gradient(transparent, rgba(255,255,255,0.1), transparent 30%);
    animation: rotateGradient 15s linear infinite;
}
@keyframes rotateGradient { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

.title {
    font-family: 'Roboto', sans-serif; 
    font-size: 56px; 
    color: #FFFFFF;
    margin: 0 auto;
    font-weight: 900; 
    text-shadow: 0 5px 15px rgba(0,0,0,0.25), 0 1px 3px rgba(0,0,0,0.4);
    letter-spacing: 1px; 
    position: relative;
    animation: titlePopIn 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    padding-bottom: 10px;
    border-bottom: 3px solid rgba(255,255,255,0.4);
    display: inline-block;
}

@keyframes titlePopIn {
    0% { opacity: 0; transform: translateY(20px) scale(0.95); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}

.subtitle {
    font-family: 'Roboto', sans-serif;
    font-size: 20px; 
    color: rgba(255,255,255,0.9);
    margin-top: 18px;
    font-weight: 400;
    text-align: center;
    animation: fadeIn 1s ease-out 0.3s backwards;
    text-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 28px;
    box-shadow: var(--shadow-lg);
    border-radius: var(--border-radius);
    overflow: hidden;
    background-color: var(--card-color);
    border: 1px solid rgba(142,234,234,0.3); 
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes highlightFade {
    0% { background-color: var(--enhanced-hover-color); }
    100% { background-color: transparent; }
}

tbody tr.new-row {
    animation: slideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

tbody tr.new-row td {
    animation: highlightFade 1.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
}

@keyframes shrinkOut {
    from {
        opacity: 1;
        transform: scaleY(1);
        height: var(--row-height, 58px);
    }
    to {
        opacity: 0;
        transform: scaleY(0);
        height: 0;
        padding-top: 0;
        padding-bottom: 0;
        border: 0;
    }
}

tbody tr.row-deleting {
    transform-origin: top;
    animation: shrinkOut 0.4s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards;
}

th, td {
    padding: 18px 20px;
    text-align: left;
    border-bottom: 1px solid rgba(142,234,234,0.2);
    font-family: 'Roboto', 'Cairo', sans-serif; 
}
tr:last-child td { border-bottom: none; }

th {
    background: linear-gradient(135deg, var(--primary-light), var(--secondary-color));
    color: white;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    font-size: 14px;
    font-family: 'Roboto', sans-serif; 
}

tr:not(.new-row, .row-deleting) { transition: var(--transition-smooth); }
tr:nth-child(even) { background-color: #F8FEFE; }

tr:hover:not(.row-deleting) {
    background-color: var(--enhanced-hover-color);
    transform: scale(1.01); 
    box-shadow: 0 0 15px rgba(11,158,158,0.2);
    z-index: 2;
    position: relative;
}

td.editable input {
    width: 90%; 
    padding: 10px 12px;
    margin: -5px 0;
    border: 1px solid transparent;
    border-radius: var(--border-radius-sm);
    font-size: inherit;
    font-family: 'Roboto', sans-serif; 
    transition: var(--transition-elegant);
    background-color: transparent;
    text-align: center;
}
td.editable input:focus {
    outline: none;
    border-color: var(--secondary-color);
    background-color: white;
    box-shadow: 0 0 0 3px var(--secondary-light), var(--shadow-sm);
    transform: scale(1.05);
}

td input[type="number"]::-webkit-inner-spin-button, 
td input[type="number"]::-webkit-outer-spin-button { 
    -webkit-appearance: none; 
    margin: 0; 
}
td input[type="number"] { -moz-appearance: textfield; }

.duplicate {
    color: var(--error-color) !important;
    background-color: #FFEBEB !important;
    text-decoration: line-through;
    animation: pulse 1.5s infinite;
}
.duplicate strong { color: var(--error-color) !important; }

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
}

.highlight {
    background-color: var(--secondary-light);
    color: var(--primary-dark);
    padding: 0.1em 0.3em;
    border-radius: 4px;
    font-weight: bold;
}

#idInfo {
    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
    padding: 24px;
    border-radius: var(--border-radius);
    margin-bottom: 28px;
    color: var(--text-color);
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
    font-family: 'Roboto', sans-serif; 
    border: 1px solid var(--border-color-subtle);
}
#idInfo strong { font-weight: 700; color: var(--primary-dark); }
#idInfo ul {
    list-style-type: none;
    padding-left: 0;
    margin-top: 10px;
    margin-bottom: 20px;
}
#idInfo li {
    padding: 6px 0 6px 25px;
    position: relative;
    font-size: 15px;
    color: var(--text-light);
}
#idInfo li::before {
    content: '→'; 
    position: absolute;
    left: 0;
    color: var(--primary-color);
    font-weight: bold;
}
#idInfo .material-icons { margin-right: 10px; color: var(--primary-color); } 

.pharmacy-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.pharmacy-item {
    background-color: #F0F9FA;
    color: var(--primary-dark); 
    padding: 16px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    transition: var(--transition-bounce);
    border: 1px solid var(--border-color-subtle); 
    cursor: pointer;
    text-align: center;
    font-weight: 700; 
    font-family: 'Cairo', 'Roboto', sans-serif; 
}

.pharmacy-item:hover {
    background-color: var(--primary-color); 
    color: white; 
    box-shadow: var(--shadow-md);
    transform: translateY(-3px) scale(1.03);
    border-color: var(--primary-dark); 
}

.class-btn-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}
.class-btn {
    flex: 1;
    background: #E0F7FA; 
    color: var(--primary-color);
    border: 2px solid var(--primary-light);
    padding: 12px 20px;
}
.class-btn.selected {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
    color: white;
    border-color: var(--primary-color);
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px) scale(1.02);
    animation: selectPulse 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}
.class-btn:not(.selected):hover {
    background: #B2EBF2;
    border-color: var(--primary-color);
}

@keyframes selectPulse {
    0% { transform: scale(1) translateY(0); }
    50% { transform: scale(1.05) translateY(-2px); }
    100% { transform: scale(1.02) translateY(-2px); }
}

.action-btn {
    background-color: transparent;
    border: 2px solid currentColor;
    padding: 8px 12px;
    border-radius: var(--border-radius-sm);
    cursor: pointer;
    transition: var(--transition-bounce);
    box-shadow: none;
    margin: 0;
    color: var(--primary-color);
}
.action-btn .material-icons { margin: 0; font-size: 22px;} 

.action-btn:hover {
    background-color: currentColor;
    color: white;
    transform: translateY(-2px) scale(1.05);
    box-shadow: var(--shadow-sm);
}
.action-btn:active {
    transform: translateY(0px) scale(1);
}

.delete-btn {
    color: var(--error-color);
}

.screen2-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

#summary-display {
    display: flex;
    flex-wrap: wrap;
    gap: 12px 24px;
    background-color: #F8FEFE;
    padding: 16px 20px;
    border-radius: var(--border-radius);
    border-left: 5px solid var(--primary-color);
    box-shadow: var(--shadow-sm);
    flex-grow: 1;
}

.summary-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
    color: var(--text-light);
    font-family: 'Roboto', sans-serif;
}
.summary-item .material-icons {
    color: var(--primary-color);
    font-size: 22px;
}
.summary-item strong {
    color: var(--text-color);
    font-weight: 700;
}

.submit-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 25px;
    gap: 20px;
}

.submit-hint {
    background-color: #E6FFFA; 
    color: var(--primary-dark);
    padding: 1rem 1.5rem;
    border-radius: var(--border-radius);
    font-size: 0.95rem;
    max-width: 400px; 
    box-shadow: var(--shadow-sm);
    border-left: 5px solid var(--secondary-color);
    transition: var(--transition-elegant);
    line-height: 1.5;
    font-family: 'Roboto', sans-serif; 
}
.submit-hint strong { font-weight: 700; color: var(--primary-color); }
.submit-hint:hover {
    box-shadow: var(--shadow-md);
    transform: translateX(4px);
}

#customModalOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(10, 25, 41, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

#customModalOverlay.visible {
    opacity: 1;
    pointer-events: auto;
}

#customModal {
    background: var(--card-color);
    padding: 24px 32px;
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-xl);
    width: 90%;
    max-width: 450px;
    text-align: center;
    transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

#customModalOverlay.visible #customModal {
    transform: scale(1);
}

#modalTitle {
    font-size: 22px;
    font-weight: 700;
    color: var(--primary-dark);
    margin-top: 0;
    margin-bottom: 12px;
}

#modalMessage {
    font-size: 16px;
    color: var(--text-light);
    line-height: 1.6;
    margin-bottom: 24px;
}

#modalActions button {
    margin: 0 8px;
    padding: 10px 24px;
    font-size: 14px;
}

#modalConfirmBtn {
    background: linear-gradient(135deg, var(--success-color) 0%, #68D391 100%);
}
#modalConfirmBtn:hover {
     background: linear-gradient(135deg, #2F855A 0%, var(--success-color) 100%);
}

#modalCancelBtn {
    background: linear-gradient(135deg, var(--error-color) 0%, #FC8181 100%);
}
#modalCancelBtn:hover {
     background: linear-gradient(135deg, #C53030 0%, var(--error-color) 100%);
}

#undoToast {
    position: fixed;
    bottom: -100px;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--text-color);
    color: white;
    padding: 14px 22px;
    border-radius: 50px;
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 15px;
    z-index: 1001;
    transition: bottom 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}

#undoToast.show {
    bottom: 25px;
}

#undoToast button {
    background: transparent;
    border: none;
    color: var(--secondary-light);
    font-weight: bold;
    cursor: pointer;
    padding: 0;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#undoToast button:hover {
    text-decoration: underline;
    color: white;
}


@media (max-width: 1200px) {
    .card { max-width: 950px; padding: 28px; }
    .title { font-size: 48px; }
    .subtitle { font-size: 18px; }
}

@media (max-width: 992px) {
    .card { max-width: 100%; padding: 24px; }
    .pharmacy-list { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    .title { font-size: 42px; }
    .subtitle { font-size: 17px; }
    .screen2-header { flex-direction: column; align-items: stretch; }
}

@media (max-width: 768px) {
    body { padding: 15px; }
    .card { padding: 20px; }
    th, td { padding: 14px 12px; font-size: 14px; }
    #searchBar { font-size: 16px; padding: 16px 20px; padding-right: 45px; }
    select, input[type="text"], input[type="number"] { padding: 14px 18px; font-size: 15px; }
    button { padding: 12px 24px; font-size: 14px; }
    .submit-container { flex-direction: column; align-items: stretch; }
    .submit-hint { margin-top: 15px; max-width: none; }
    .title { font-size: 36px; }
    .subtitle { font-size: 16px; }
    .class-btn-container { flex-direction: column; }
    #summary-display { gap: 8px 16px; padding: 12px 16px;}
    .summary-item { font-size: 14px; }
}

@media (max-width: 480px) {
    body { padding: 10px; }
    .card { padding: 15px; }
    .pharmacy-list { grid-template-columns: 1fr; }
    button { width: 100%; margin: 8px 0; font-size: 13px; padding: 12px 20px; }
    button#backBtn, .action-btn { width: auto; }
    #idInfo { font-size: 14px; padding: 18px; }
    #searchBar { font-size: 15px; padding: 14px 18px; padding-right: 40px; }
    select, input[type="text"], input[type="number"] { padding: 12px 16px; font-size: 14px; }
    .title { font-size: 30px; }
    .subtitle { font-size: 15px; }
    th, td { padding: 12px 8px; font-size: 13px; }
    td.editable input { width: 100%; }
    .screen2-header { margin-bottom: 16px; }
    #undoToast { width: calc(100% - 20px); text-align: center; justify-content: center; }
}
    </style>
</head>
<body>
    <div class="title-container">
        <h1 class="title">بيان الخارجي</h1>
    </div>

    <div id="screen1" class="card">
        <div id="idInfo">
            <p><i class="material-icons">info_outline</i><strong>Quick Select & ID Guide:</strong> Use the ID input for autofill, or use the dropdowns below.</p>
            <ul>
                <li>1st character: 'a' for student, 'b' for workforce.</li>
                <li>2nd character: '1' for first region, '2' for second, '3' for third.</li>
                <li>3rd character: Specific pharmacy number.</li>
            </ul>
             <input type="text" id="id" placeholder="Enter ID (e.g., a21) or use buttons" autocomplete="off">
            <div class="pharmacy-list" id="pharmacyList">
            </div>
        </div>
       
        <div class="class-btn-container">
            <button class="class-btn" data-class="student"><i class="material-icons">school</i>Student</button>
            <button class="class-btn" data-class="workforce"><i class="material-icons">work</i>Workforce</button>
        </div>
        <select id="region" required>
            <option value="" disabled selected>Select Region</option>
            <option value="first">First</option>
            <option value="second">Second</option>
            <option value="third">Third</option>
        </select>
        <select id="pharmacy" required>
            <option value="" disabled selected>Select Pharmacy</option>
        </select>
       <input type="number" id="month" placeholder="Month (1-12)" min="1" max="12" required>
        <button id="nextBtn">Next <i class="material-icons">arrow_forward</i></button>
    </div>

    <div id="screen2" class="card hidden">
        <div class="screen2-header">
            <button id="backBtn"><i class="material-icons">arrow_back</i>Edit Selections</button>
            <div id="summary-display">
                <div class="summary-item">
                    <i class="material-icons" title="Class">work_outline</i>
                    <strong id="summary-class"></strong>
                </div>
                <div class="summary-item">
                    <i class="material-icons" title="Region">public</i>
                    <strong id="summary-region"></strong>
                </div>
                <div class="summary-item">
                    <i class="material-icons" title="Pharmacy">local_pharmacy</i>
                    <strong id="summary-pharmacy"></strong>
                </div>
                <div class="summary-item">
                    <i class="material-icons" title="Month">calendar_today</i>
                    <strong id="summary-month"></strong>
                </div>
                <div class="summary-item">
                    <i class="material-icons" title="ID">fingerprint</i>
                    <strong id="summary-id"></strong>
                </div>
            </div>
        </div>

        <input type="text" id="searchBar" placeholder="Search for an item to add...">
        <div id="didYouMean"></div>
        <div id="suggestions"></div>
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Unit</th>
                    <th>Units Sold</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <div class="submit-container">
            <button id="submitBtn"><i class="material-icons">send</i>Submit</button>
            <div class="submit-hint">
                <strong>Final Step:</strong> Review your entries carefully. Once submitted, the data for this pharmacy and month cannot be altered in this session.
            </div>
        </div>
    </div>
    
    <div id="customModalOverlay">
        <div id="customModal">
            <h2 id="modalTitle"></h2>
            <p id="modalMessage"></p>
            <div id="modalActions">
                <button id="modalCancelBtn">Cancel</button>
                <button id="modalConfirmBtn">OK</button>
            </div>
        </div>
    </div>
    
    <div id="undoToast">
        <span id="undoMessage"></span>
        <button id="undoBtn">Undo</button>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBYmguP4MPNvKV3ZeoR-MploiVZKgyAga8",
  authDomain: "the-other-plan.firebaseapp.com",
  databaseURL: "https://the-other-plan-default-rtdb.firebaseio.com",
  projectId: "the-other-plan",
  storageBucket: "the-other-plan.appspot.com",
  messagingSenderId: "465003350934",
  appId: "1:465003350934:web:ca48924ffad36396cf6bb7",
  measurementId: "G-6LVGSBLK09"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const screen1 = document.getElementById('screen1');
const screen2 = document.getElementById('screen2');
const idInput = document.getElementById('id');
const classButtons = document.querySelectorAll('.class-btn');
const regionSelect = document.getElementById('region');
const pharmacySelect = document.getElementById('pharmacy');
const monthInput = document.getElementById('month');
const nextBtn = document.getElementById('nextBtn');
const backBtn = document.getElementById('backBtn');
const searchBar = document.getElementById('searchBar');
const suggestions = document.getElementById('suggestions');
const didYouMean = document.getElementById('didYouMean');
const dataTable = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
const submitBtn = document.getElementById('submitBtn');
const pharmacyList = document.getElementById('pharmacyList');

let selectedClass = '';
let selectedItems = [];
let isSubmitting = false;
let isUpdatingFromId = false;
let isUpdatingFromDropdowns = false;
let lastDeleted = null;

const items = [
    { name: "5-Fluorouracil 250mg", unit: "Amp", price: 12 },
    { name: "Acetazolamide 250mg", unit: "10 T", price: 12 },
    { name: "Acetylcysteine Sachets", unit: "10 Sach", price: 12 },
    { name: "Acetylsalicylic Acid 75mg", unit: "10 T", price: 12 },
    { name: "Acetylsalicylic Acid 81mg", unit: "10 T", price: 12 },
    { name: "Acyclovir 0.05 cream", unit: "Tube", price: 12 },
    { name: "Acyclovir 400mg", unit: "10 T", price: 12 },
    { name: "Aescin gel", unit: "Tube", price: 12 },
    { name: "Allopurinol 100mg", unit: "10 T", price: 12 },
    { name: "Allopurinol 300mg", unit: "10 T", price: 12 },
    { name: "Alpha Chymotrypsin", unit: "Amp", price: 12 },
    { name: "Alpha Lipoic Acid 300mg", unit: "10 T", price: 12 },
    { name: "Alpha Lipoic Acid 600mg", unit: "10 T", price: 12 },
    { name: "Amantadine HCL 100mg", unit: "10 T", price: 12 },
    { name: "Amaryl 2mg (حكم قضائي)", unit: "30 T", price: 12 },
    { name: "Ambroxol", unit: "10 T", price: 12 },
    { name: "Ambroxol Syp", unit: "B", price: 12 },
    { name: "Amiloride 5mg & HCT 50mg", unit: "10T", price: 12 },
    { name: "Amiodarone 200mg", unit: "10 T", price: 12 },
    { name: "Amitriptyline 10mg", unit: "10 T", price: 12 },
    { name: "Amitriptyline 25mg", unit: "10 T", price: 12 },
    { name: "Amlodipine 10mg", unit: "10T", price: 12 },
    { name: "Amlodipine 5mg", unit: "10 T", price: 12 },
    { name: "Amlodipine 5mg & Olmesartan 20mg", unit: "10 T", price: 12 },
    { name: "Amlodipine, Olmesartan & HCT 10/40/25mg", unit: "10 T", price: 12 },
    { name: "Amlodipine, Olmesartan & HCT 5/20/12.5mg", unit: "10 T", price: 12 },
    { name: "Amoxicillin & Clavulanic acid 1 gm", unit: "10 T", price: 12 },
    { name: "Amoxicillin 500mg", unit: "10 Cap", price: 12 },
    { name: "Anagrelide 0.5mg", unit: "10 T", price: 12 },
    { name: "Andovimpamide 100mg (استثناء من مدير الفرع)", unit: "10 T", price: 12 },
    { name: "Antacid", unit: "10 T", price: 12 },
    { name: "Antacid Syp", unit: "B", price: 12 },
    { name: "Anti-migraine", unit: "10 T", price: 12 },
    { name: "Antibiotic & Corticosteroid cream", unit: "Tube", price: 12 },
    { name: "Antifungal cream", unit: "Tube", price: 12 },
    { name: "Antirheumatic gel", unit: "Tube", price: 12 },
    { name: "Antispasmodic", unit: "10T", price: 12 },
    { name: "Apetryl 0.5mg (تم الصرف بالاسم التجاري وفقا لتأشيرة الشئون الطبية)", unit: "10 T", price: 12 },
    { name: "Apixaban 2.5mg", unit: "10 T", price: 12 },
    { name: "Apixaban 5mg", unit: "10 T", price: 12 },
    { name: "Aranesp 100mcg", unit: "Syringe", price: 12 },
    { name: "Aripiprazole 30mg", unit: "10 T", price: 12 },
    { name: "Artificial Tears", unit: "B", price: 12 },
    { name: "Atorvastatin & Ezetimibe 10/10 mg", unit: "10 T", price: 12 },
    { name: "Atorvastatin & Ezetimibe 20/10 mg", unit: "10 T", price: 12 },
    { name: "Atorvastatin & Ezetimibe 40/10 mg", unit: "10 T", price: 12 },
    { name: "Atorvastatin 10mg", unit: "10 T", price: 12 },
    { name: "Atorvastatin 20mg", unit: "10 T", price: 12 },
    { name: "Atorvastatin 40mg", unit: "10 T", price: 12 },
    { name: "Atropine Sulphate ED", unit: "B", price: 12 },
    { name: "Atropine Sulphate, Colchicine & Piperazine Sachets", unit: "12 Sach", price: 12 },
    { name: "Avonex 30mcg (قرار لجنة)", unit: "Syringe", price: 12 },
    { name: "Azathioprine 50 mg", unit: "10 T", price: 12 },
    { name: "Beclomethasone & Salbutamol Inhalation", unit: "B", price: 12 },
    { name: "Beclomethasone Inhalation", unit: "B", price: 12 },
    { name: "Bendamustin 100mg", unit: "vial", price: 12 },
    { name: "Benztropine 2mg", unit: "10 T", price: 12 },
    { name: "Benzyl benzoate cream", unit: "Tube", price: 12 },
    { name: "Betaferon (قرار لجنة)", unit: "Syringe", price: 12 },
    { name: "Betahistine 8mg", unit: "10 T", price: 12 },
    { name: "Betamethasone & Calcipotriol Cr.", unit: "Tube", price: 12 },
    { name: "Betamethasone & Salicylic acid Lotion", unit: "B", price: 12 },
    { name: "Betamethasone & Salicylic acid Oint.", unit: "Tube", price: 12 },
    { name: "Betamethasone Cr.", unit: "Tube", price: 12 },
    { name: "Betaxolol", unit: "B", price: 12 },
    { name: "Bilichol", unit: "12 Cap", price: 12 },
    { name: "Bional (قرار لجنة)", unit: "10 T", price: 12 },
    { name: "Biperidene 2mg", unit: "10 T", price: 12 },
    { name: "Bisoprolol 2.5mg", unit: "10 T", price: 12 },
    { name: "Bisoprolol 5mg", unit: "10 T", price: 12 },
    { name: "Bisoprolol 5mg & HCT 12.5mg", unit: "10 T", price: 12 },
    { name: "Bleomycin 15 I.U", unit: "Vial", price: 12 },
    { name: "Bosentan 62.5mg", unit: "10 T", price: 12 },
    { name: "Brimonidine ED", unit: "B", price: 12 },
    { name: "Budesonide 160mcg & Formoterol 4.5mcg", unit: "B", price: 12 },
    { name: "Bumetanide", unit: "10 T", price: 12 },
    { name: "Cabergoline 0.5mg", unit: "2 T", price: 12 },
    { name: "Caelyx", unit: "Vial", price: 12 },
    { name: "Calamine & Antihistamine Lotion", unit: "B", price: 12 },
    { name: "Calcium 500mg", unit: "10 T", price: 12 },
    { name: "Candesartan 16 mg", unit: "10 T", price: 12 },
    { name: "Candesartan 16mg & HCT 12.5mg", unit: "10 T", price: 12 },
    { name: "Candesartan 8mg", unit: "10 T", price: 12 },
    { name: "Capecitabine 500mg", unit: "T", price: 12 },
    { name: "Capoten 25mg (حكم قضائي)", unit: "10 T", price: 12 },
    { name: "Captopril 50mg & HCT 25mg", unit: "10 T", price: 12 },
    { name: "Carbamazepin 200mg", unit: "10 T", price: 12 },
    { name: "Carbamazepin 400mg CR", unit: "10 T", price: 12 },
    { name: "Carbamide cream", unit: "Tube", price: 12 },
    { name: "Carbimazole 5mg", unit: "10 T", price: 12 },
    { name: "Carboplatin 150mg", unit: "Vial", price: 12 },
    { name: "Carboplatin 450mg", unit: "Vial", price: 12 },
    { name: "Carfilzomib 60mg", unit: "Vial", price: 12 },
    { name: "Carvedilol 12.5mg", unit: "10T", price: 12 },
    { name: "Carvedilol 25mg", unit: "10 T", price: 12 },
    { name: "Carvedilol 6.25mg", unit: "10 T", price: 12 },
    { name: "Celecoxib 200mg", unit: "10 T", price: 12 },
    { name: "Central Muscle Relaxant & Analgesic", unit: "10 T", price: 12 },
    { name: "Cephalexine 500", unit: "10 Cap", price: 12 },
    { name: "Cetirizine", unit: "10 T", price: 12 },
    { name: "Cetuximab 100mg", unit: "Vial", price: 12 },
    { name: "Chlorpromazine 100mg", unit: "10 T", price: 12 },
    { name: "Cholecalciferol 10000IU", unit: "10 T", price: 12 },
    { name: "Cholestyramine Sachets", unit: "12 Sach", price: 12 },
    { name: "Chymotrypsin & Trypsin", unit: "10 T", price: 12 },
    { name: "Cidophage 850mg (حكم قضائي)", unit: "10 T", price: 12 },
    { name: "Cilostazole 100mg", unit: "10 T", price: 12 },
    { name: "Cilostazole 50mg", unit: "10 T", price: 12 },
    { name: "Cinacalcet 30mg", unit: "10 T", price: 12 },
    { name: "Cinchocaine & Hydrocortisone Supp", unit: "6 Supp", price: 12 },
    { name: "Cinchocaine & Hydrocortisone cream", unit: "Tube", price: 12 },
    { name: "Cinnarizine 25mg", unit: "10 T", price: 12 },
    { name: "Cipralex 10mg (تم الصرف بالاسم التجاري وفقا لتأشيرة الشئون الطبية)", unit: "14 T", price: 12 },
    { name: "Ciprapro (استثناء مدير الفرع)", unit: "10 T", price: 12 },
    { name: "Ciprofloxacin 500mg", unit: "10 T", price: 12 },
    { name: "Citalopram 20mg", unit: "7 T", price: 12 },
    { name: "Citicoline 500mg", unit: "Amp", price: 12 },
    { name: "Citicoline Syp", unit: "B", price: 12 },
    { name: "Clobetasol Cream", unit: "Tube", price: 12 },
    { name: "Clomipramine 25mg", unit: "10 T", price: 12 },
    { name: "Clomipramine 75mg", unit: "10 T", price: 12 },
    { name: "Clopidogrel 75mg", unit: "10 T", price: 12 },
    { name: "Clotrimazole Cream", unit: "Tube", price: 12 },
    { name: "Clotrimazole Soln.", unit: "B", price: 12 },
    { name: "Clozapine 100mg", unit: "10 T", price: 12 },
    { name: "Colchicine", unit: "10 T", price: 12 },
    { name: "Cough Sedative", unit: "B", price: 12 },
    { name: "Cyclosporin 50mg", unit: "10 T", price: 12 },
    { name: "Cytarabine 1gm", unit: "Vial", price: 12 },
    { name: "Dapagliflozin 10mg", unit: "10 T", price: 12 },
    { name: "Dapagliflozin 10mg & Met. 1000mg", unit: "10 T", price: 12 },
    { name: "Dapagliflozin 5mg & Met. 1000mg", unit: "10 T", price: 12 },
    { name: "Darbepoetin Alpha (لجنه عليا)", unit: "Syringe", price: 12 },
    { name: "Deferoxamine 500mg", unit: "Amp", price: 12 },
    { name: "Dexamethasone , Neomycine & Polimyxin ED", unit: "B", price: 12 },
    { name: "Dexamethasone , Neomycine & Polimyxin EO", unit: "Tube", price: 12 },
    { name: "Diacerein 50mg", unit: "10 T", price: 12 },
    { name: "Diamicron MR (حكم قضائي)", unit: "30 T", price: 12 },
    { name: "Diclofenac 100mg supp", unit: "5 Supp", price: 12 },
    { name: "Diclofenac 75mg amp", unit: "Amp", price: 12 },
    { name: "Diclofenac gel", unit: "Tube", price: 12 },
    { name: "Diclofenac sodium 50mg", unit: "10 T", price: 12 },
    { name: "Digestive", unit: "10 T", price: 12 },
    { name: "Digestive Syp", unit: "B", price: 12 },
    { name: "Digoxine 0.25mg", unit: "10 T", price: 12 },
    { name: "Diltiazem 60mg", unit: "10 T", price: 12 },
    { name: "Diltiazem 90mg", unit: "10T", price: 12 },
    { name: "Diosmin 450mg & Hesperidin 50mg", unit: "10 T", price: 12 },
    { name: "Domperidone 10mg", unit: "10 T", price: 12 },
    { name: "Dorzolamide & Timolol ED", unit: "B", price: 12 },
    { name: "Dostenix (حكم قضائي)", unit: "2 T", price: 12 },
    { name: "Dothiepin 25mg", unit: "10 T", price: 12 },
    { name: "Dothiepin 75mg", unit: "10 T", price: 12 },
    { name: "Doxazosin 1mg", unit: "10 T", price: 12 },
    { name: "Doxazosin 4mg", unit: "10 T", price: 12 },
    { name: "Doxorubicin 20mg", unit: "Vial", price: 12 },
    { name: "Doxycycline 100mg", unit: "10 Cap", price: 12 },
    { name: "Duloxetine 30mg", unit: "10 T", price: 12 },
    { name: "Dydrogesterone 10mg", unit: "10 T", price: 12 },
    { name: "Empagliflozin 12.5mg & Met. 1000mg", unit: "10 T", price: 12 },
    { name: "Empagliflozin 25mg", unit: "10 T", price: 12 },
    { name: "Empagliflozin 25mg & Met. 1000mg", unit: "10 T", price: 12 },
    { name: "Empagliflozin 5mg & Met. 1000mg", unit: "10 T", price: 12 },
    { name: "Enalapril 20mg & HCT 12.5mg", unit: "10 T", price: 12 },
    { name: "Endoxan 1g", unit: "Vial", price: 12 },
    { name: "Endoxan 50mg", unit: "50T", price: 12 },
    { name: "Enoxaparin 20mg", unit: "Syringe", price: 12 },
    { name: "Enoxaparin 40mg", unit: "Syringe", price: 12 },
    { name: "Enoxaparin 60mg", unit: "Syringe", price: 12 },
    { name: "Enoxaparin 80mg", unit: "Syringe", price: 12 },
    { name: "Entecavir 0.5mg", unit: "10 T", price: 12 },
    { name: "Entecavir 1mg", unit: "10 T", price: 12 },
    { name: "Erythropoietin alpha 4000IU", unit: "Vial", price: 12 },
    { name: "Escitalopram 10mg", unit: "14T", price: 12 },
    { name: "Esomeprazole 40 mg", unit: "10 Cap", price: 12 },
    { name: "Estradiol Valerate & Norgestrel", unit: "21 T", price: 12 },
    { name: "Ethamsylate 250 mg", unit: "10 T", price: 12 },
    { name: "Etoposide 100mg", unit: "Amp", price: 12 },
    { name: "Etoricoxib 120mg", unit: "10 T", price: 12 },
    { name: "Etoricoxib 90mg", unit: "10 T", price: 12 },
    { name: "Famotidine 20 mg", unit: "10 T", price: 12 },
    { name: "Famotidine 40mg", unit: "10 T", price: 12 },
    { name: "Febuxostat 40mg", unit: "10 T", price: 12 },
    { name: "Febuxostat 80mg", unit: "10 T", price: 12 },
    { name: "Fenofibrate 300mg", unit: "10 T", price: 12 },
    { name: "Ferro Sanol Duodenal (موافقة الشئون الطبية)", unit: "30 T", price: 12 },
    { name: "Fexofenadine 120mg", unit: "10 T", price: 12 },
    { name: "Fexofenadine 180mg", unit: "10 T", price: 12 },
    { name: "Flavoxate 200mg", unit: "10 T", price: 12 },
    { name: "Fluconazole 150mg", unit: "1 T", price: 12 },
    { name: "Fluoxetine 20mg", unit: "10 T", price: 12 },
    { name: "Fluticasone 125mcg & Salmeterol 25mcg", unit: "B", price: 12 },
    { name: "Folic acid", unit: "10 T", price: 12 },
    { name: "Formoterol", unit: "30 T", price: 12 },
    { name: "Fucidic Acid Cream", unit: "Tube", price: 12 },
    { name: "Furosemide 20mg & Spironolactone 50mg", unit: "10 T", price: 12 },
    { name: "Furosemide 40mg", unit: "10 T", price: 12 },
    { name: "Gabapentin 100mg", unit: "10 T", price: 12 },
    { name: "Gabapentin 400mg", unit: "10 T", price: 12 },
    { name: "Galvus 50mg (حكم قضائي )", unit: "28 T", price: 12 },
    { name: "Gastrobiotic 550mg (لجنه عليا)", unit: "10 T", price: 12 },
    { name: "Gentamicin 80mg", unit: "Amp", price: 12 },
    { name: "Gentamicin Cream", unit: "Tube", price: 12 },
    { name: "Gilenya 0.5mg", unit: "28 Cap", price: 12 },
    { name: "Ginkgo biloba", unit: "10 T", price: 12 },
    { name: "Glibenclamide 5mg", unit: "10 T", price: 12 },
    { name: "Glibenclamide 5mg & Met. 1000mg", unit: "10 T", price: 12 },
    { name: "Glibenclamide 5mg & Met. 500mg", unit: "10 T", price: 12 },
    { name: "Gliclazide 60mg", unit: "10 T", price: 12 },
    { name: "Glimepiride 2mg", unit: "10 T", price: 12 },
    { name: "Glimepiride 2mg & Met. 1000mg", unit: "10 T", price: 12 },
    { name: "Glimepiride 3mg", unit: "10 T", price: 12 },
    { name: "Glimepiride 4mg", unit: "10 T", price: 12 },
    { name: "Glucosamine", unit: "10 T", price: 12 },
    { name: "Gramicidin, Neomycin, Nystatin & Triamcinolone Cream", unit: "Tube", price: 12 },
    { name: "Haloperidol 5 mg", unit: "10 T", price: 12 },
    { name: "Haloperidol 5mg", unit: "Amp", price: 12 },
    { name: "Hexamine, Khellin & Piperazin Sachets", unit: "12 Sach", price: 12 },
    { name: "Human chorionic gonadotropin", unit: "Amp", price: 12 },
    { name: "Hydroxychloroquine", unit: "10 T", price: 12 },
    { name: "Hydroxyurea", unit: "10 T", price: 12 },
    { name: "Ibuprofen 200mg", unit: "10 T", price: 12 },
    { name: "Imipramine 25mg", unit: "10 T", price: 12 },
    { name: "Indepamid 2.5 mg", unit: "10 T", price: 12 },
    { name: "Indomethacin 100mg Supp.", unit: "10 Supp", price: 12 },
    { name: "Insulin Isophane Protamine", unit: "Penfill", price: 12 },
    { name: "Insulin Isophane Protamine", unit: "Vial", price: 12 },
    { name: "Insulin Mix 70/30 (Insulin Isophane Protamine & Insulin Neutral Human)", unit: "Penfill", price: 12 },
    { name: "Insulin Mix 70/30 (Insulin Isophane Protamine & Insulin Neutral Human)", unit: "Vial", price: 12 },
    { name: "Insulin Neutral Human", unit: "Penfill", price: 12 },
    { name: "Insulin Neutral Human", unit: "Vial", price: 12 },
    { name: "Invega 100mg (قرار لجنة)", unit: "Syringe", price: 12 },
    { name: "Invega 150mg (قرار لجنة)", unit: "Syringe", price: 12 },
    { name: "Ipratropium & Salbutamol", unit: "Amp", price: 12 },
    { name: "Irinotecan 100mg", unit: "Vial", price: 12 },
    { name: "Iron", unit: "10 T", price: 12 },
    { name: "Iruxol", unit: "Tube", price: 12 },
    { name: "Isosorbide Mononitrate 20mg", unit: "10 T", price: 12 },
    { name: "Ivabradine 5mg", unit: "10 T", price: 12 },
    { name: "Ivabradine 7.5mg", unit: "10 T", price: 12 },
    { name: "Ketoprofen 50mg", unit: "10 T", price: 12 },
    { name: "Ketosteril", unit: "100 T", price: 12 },
    { name: "Ketotifen", unit: "10 T", price: 12 },
    { name: "L-Carnitine Amp", unit: "Amp", price: 12 },
    { name: "L-Carnitine Cap", unit: "10 Cap", price: 12 },
    { name: "Lacosamide 100 mg", unit: "10 T", price: 12 },
    { name: "Lactulose Syp", unit: "B", price: 12 },
    { name: "Lamivudine", unit: "10 T", price: 12 },
    { name: "Lamotrigine 100mg", unit: "10 T", price: 12 },
    { name: "Lamotrigine 50mg", unit: "10 T", price: 12 },
    { name: "Latanoprost ED", unit: "B", price: 12 },
    { name: "Laxative", unit: "10 T", price: 12 },
    { name: "Leflunomide 20mg", unit: "10 T", price: 12 },
    { name: "Lercanidipine 10mg", unit: "10 T", price: 12 },
    { name: "Leucovorin Calcium 50mg", unit: "Amp", price: 12 },
    { name: "Levetiracetam 1000mg", unit: "10 T", price: 12 },
    { name: "Levetiracetam 500mg", unit: "10 T", price: 12 },
    { name: "Levodopa & Carbidopa 250/25mg", unit: "10 T", price: 12 },
    { name: "Levodopa, Carbidopa & Entacapone 150/37.5/200mg", unit: "10 T", price: 12 },
    { name: "Levofloxacin 500mg", unit: "10 T", price: 12 },
    { name: "Levothyroxine 100mcg", unit: "100 T", price: 12 },
    { name: "Levothyroxine 25mcg", unit: "50 T", price: 12 },
    { name: "Levothyroxine 50mcg", unit: "100 T", price: 12 },
    { name: "Lidocaine cream", unit: "Tube", price: 12 },
    { name: "Linezolid 600 mg", unit: "10 T", price: 12 },
    { name: "Lisinopril 10mg", unit: "10 T", price: 12 },
    { name: "Lithium Carbonate 400mg", unit: "10 T", price: 12 },
    { name: "Lolawest (قرار لجنة)", unit: "6 Sach", price: 12 },
    { name: "Long Acting Penicillin", unit: "Vial", price: 12 },
    { name: "Losartan 50mg", unit: "10 T", price: 12 },
    { name: "Losartan 50mg & HCT 12.5mg", unit: "10 T", price: 12 },
    { name: "Magnesium Citrate Eff.", unit: "12 Sach", price: 12 },
    { name: "Mayzent 0.25 mg (لجنة)", unit: "12 T", price: 12 },
    { name: "Mebeverine 100mg & Sulpiride 25mg", unit: "10 T", price: 12 },
    { name: "Meclofenoxate 500mg", unit: "10 T", price: 12 },
    { name: "Memantine 10 mg", unit: "10 T", price: 12 },
    { name: "Mesalazine 500mg", unit: "10 T", price: 12 },
    { name: "Mesalazine Supp", unit: "28 Supp", price: 12 },
    { name: "Metformin 500mg", unit: "10 T", price: 12 },
    { name: "Metformin 850mg", unit: "10 T", price: 12 },
    { name: "Methotrexate", unit: "Vial", price: 12 },
    { name: "Methotrexate 2.5mg", unit: "10 T", price: 12 },
    { name: "Methyl Folate (لجنة دواء)", unit: "10 T", price: 12 },
    { name: "Methyldopa 250mg", unit: "10 T", price: 12 },
    { name: "Metoclopramide 10mg", unit: "10 T", price: 12 },
    { name: "Metoprolol 100mg", unit: "10 T", price: 12 },
    { name: "Metoprolol 50mg", unit: "10 T", price: 12 },
    { name: "Metronidazole 250mg", unit: "10 T", price: 12 },
    { name: "Miconazole vaginal cream", unit: "Tube", price: 12 },
    { name: "Minirin 60mcg (قرار لجنة)", unit: "30T", price: 12 },
    { name: "Mometasone Cream", unit: "Tube", price: 12 },
    { name: "Montelukast 10mg", unit: "10 T", price: 12 },
    { name: "Mouth Wash", unit: "B", price: 12 },
    { name: "Multivitamins", unit: "10 Cap", price: 12 },
    { name: "Mycophenolate 180mg", unit: "10 T", price: 12 },
    { name: "Mycophenolate 500mg", unit: "10 T", price: 12 },
    { name: "N-plate", unit: "Syringe", price: 12 },
    { name: "Naftidrofuryl 200mg", unit: "10 T", price: 12 },
    { name: "Naphazoline & Chlorpheniramine ED", unit: "B", price: 12 },
    { name: "Napizole 20mg (حكم قضائي )", unit: "14 T", price: 12 },
    { name: "Navelbin 20mg", unit: "T", price: 12 },
    { name: "Nebivolol 2.5mg", unit: "10 T", price: 12 },
    { name: "Nebivolol 5mg", unit: "10 T", price: 12 },
    { name: "Nebivolol 5mg & HCT 12.5mg", unit: "10 T", price: 12 },
    { name: "Nebivolol 5mg & HCT 25mg", unit: "10 T", price: 12 },
    { name: "Neostigmine 15mg", unit: "10 T", price: 12 },
    { name: "Nicorandil 10mg", unit: "10 T", price: 12 },
    { name: "Nicorandil 20mg", unit: "10 T", price: 12 },
    { name: "Nifedipine", unit: "10 T", price: 12 },
    { name: "Nitroglycerin 2.5mg", unit: "10 Cap", price: 12 },
    { name: "Nitroglycerin 5mg Patches", unit: "Patch", price: 12 },
    { name: "Nitromak 2.5mg (حكم قضائي)", unit: "10 T", price: 12 },
    { name: "Norethisterone", unit: "10 T", price: 12 },
    { name: "Ofev (حكم قضائي)", unit: "60 T", price: 12 },
    { name: "Olanzapine 10mg", unit: "10 T", price: 12 },
    { name: "Olmesartan 20mg", unit: "10 T", price: 12 },
    { name: "Olmesartan 20mg & HCT 12.5mg", unit: "10 T", price: 12 },
    { name: "Olmesartan 40mg", unit: "10 T", price: 12 },
    { name: "Omega 3", unit: "10 T", price: 12 },
    { name: "Omeprazole 20mg", unit: "7 T", price: 12 },
    { name: "Omeprazole 40mg", unit: "10 T", price: 12 },
    { name: "Opsumit 10mg", unit: "30 T", price: 12 },
    { name: "Oxcarbazepine 300mg", unit: "10 T", price: 12 },
    { name: "Oxybutynin 5mg", unit: "10 T", price: 12 },
    { name: "Panthenol cream", unit: "Tube", price: 12 },
    { name: "Pantoprazole 20mg", unit: "10 T", price: 12 },
    { name: "Pantoprazole 40mg", unit: "10 T", price: 12 },
    { name: "Paracetamol 500mg", unit: "10 T", price: 12 },
    { name: "Pentasa (لجنة عليا)", unit: "10 T", price: 12 },
    { name: "Pentasa Supp (لجنة عليا)", unit: "28 Supp", price: 12 },
    { name: "Pentoxifylline 400mg", unit: "10 T", price: 12 },
    { name: "Phenytoin 100mg", unit: "10 T", price: 12 },
    { name: "Phenytoin 50mg", unit: "10 T", price: 12 },
    { name: "Pimozide 4mg", unit: "10 T", price: 12 },
    { name: "Piracetam 400mg", unit: "10 T", price: 12 },
    { name: "Piracetam 800mg", unit: "10 T", price: 12 },
    { name: "Piracetam Syp", unit: "B", price: 12 },
    { name: "Pirfenex (حكم قضائي)", unit: "30 T", price: 12 },
    { name: "Pirfenidone 200mg (قرار لجنة )", unit: "30 T", price: 12 },
    { name: "Piroxicam 10mg", unit: "10 T", price: 12 },
    { name: "Piroxicam 20mg", unit: "10 T", price: 12 },
    { name: "Plendil 5mg (موافقة الشئون الطبية)", unit: "30 T", price: 12 },
    { name: "Ponvory (Ponesimod 20 mg) (قرار لجنة)", unit: "28 T", price: 12 },
    { name: "Potassium", unit: "B", price: 12 },
    { name: "Povidone Iodine Shampoo", unit: "B", price: 12 },
    { name: "Pramipexol 0.25mg", unit: "10 T", price: 12 },
    { name: "Pramipexol 1 mg", unit: "10 T", price: 12 },
    { name: "Prednisolone 20mg", unit: "10 T", price: 12 },
    { name: "Prednisolone 5mg", unit: "10 T", price: 12 },
    { name: "Prednisolone ED", unit: "B", price: 12 },
    { name: "Progesteron 100mg", unit: "10 Cap", price: 12 },
    { name: "Progesteron 250mg", unit: "Amp", price: 12 },
    { name: "Propafenone 150mg", unit: "10 T", price: 12 },
    { name: "Propolis, Chamomile, Zinc Oxide & Honey Cream", unit: "Tube", price: 12 },
    { name: "Propranolol 10mg", unit: "10 T", price: 12 },
    { name: "Propranolol 40mg", unit: "10 T", price: 12 },
    { name: "Propylthiouracil 50mg", unit: "10 T", price: 12 },
    { name: "Pyridostigmine 60mg", unit: "10 T", price: 12 },
    { name: "Quetiapine 100mg", unit: "10 T", price: 12 },
    { name: "Quinidine sulphate 250mg", unit: "10T", price: 12 },
    { name: "Ramipril 10mg", unit: "10 T", price: 12 },
    { name: "Ramipril 2.5 mg", unit: "10 T", price: 12 },
    { name: "Ramipril 5mg", unit: "10T", price: 12 },
    { name: "Ramipril 5mg & Felodipine 5mg", unit: "10 T", price: 12 },
    { name: "Rasagiline 1mg", unit: "10 T", price: 12 },
    { name: "Rebamipide", unit: "10 T", price: 12 },
    { name: "Rebif 44mcg (قرار لجنة)", unit: "Syringe", price: 12 },
    { name: "Rilutek (قرار لجنة)", unit: "56 T", price: 12 },
    { name: "Riluzole 50mg", unit: "56 T", price: 12 },
    { name: "Risperidone 1 mg", unit: "10 T", price: 12 },
    { name: "Risperidone 2 mg", unit: "10 T", price: 12 },
    { name: "Risperidone 3 mg", unit: "10 T", price: 12 },
    { name: "Rivaroxaban 10mg", unit: "10 T", price: 12 },
    { name: "Rivaroxaban 15mg", unit: "10 T", price: 12 },
    { name: "Rivaroxaban 20mg", unit: "10 T", price: 12 },
    { name: "Rivaroxban 2.5mg", unit: "10 T", price: 12 },
    { name: "Rosuvastatin 20mg", unit: "10 T", price: 12 },
    { name: "Rutin & Vit.C", unit: "10 T", price: 12 },
    { name: "Salbutamol", unit: "10 T", price: 12 },
    { name: "Salbutamol Inhaler", unit: "B", price: 12 },
    { name: "Salbutamol Syp", unit: "B", price: 12 },
    { name: "Sandostatin LAR", unit: "Syringe", price: 12 },
    { name: "Sertraline 50 mg", unit: "10 T", price: 12 },
    { name: "Sildenafil 20mg", unit: "10 T", price: 12 },
    { name: "Sildenafil 50mg", unit: "10 T", price: 12 },
    { name: "Sirolimus 1gm", unit: "10 T", price: 12 },
    { name: "Sitagliptin 100mg", unit: "10 T", price: 12 },
    { name: "Sitagliptin 50 mg & Met. 1000 mg", unit: "10 T", price: 12 },
    { name: "Sodium Valproate 200mg", unit: "10 T", price: 12 },
    { name: "Sodium Valproate 500mg", unit: "10 T", price: 12 },
    { name: "Solifenacin 10mg", unit: "10 T", price: 12 },
    { name: "Spiramycin 3MIU Tab", unit: "10 T", price: 12 },
    { name: "Spironolactone 100 mg", unit: "10 T", price: 12 },
    { name: "Spironolactone 25mg", unit: "10 T", price: 12 },
    { name: "Stivarga 40mg", unit: "84T", price: 12 },
    { name: "Sulphamethoxazole & Trimethoprim", unit: "10 T", price: 12 },
    { name: "Tacrolimus 1mg", unit: "10 T", price: 12 },
    { name: "Tadalafil 5 mg", unit: "10 T", price: 12 },
    { name: "Tamoxifen 10mg", unit: "10 T", price: 12 },
    { name: "Tamsulosin 0.4mg", unit: "14T", price: 12 },
    { name: "Tenofenamide 25mg", unit: "10 T", price: 12 },
    { name: "Tenofovir 300mg", unit: "30 T", price: 12 },
    { name: "Terbinafine 0.01 Cream", unit: "Tube", price: 12 },
    { name: "Terbutaline", unit: "10 T", price: 12 },
    { name: "Testosterone", unit: "Amp", price: 12 },
    { name: "Tetracosactrin", unit: "Amp", price: 12 },
    { name: "Theophylline 300mg", unit: "10 T", price: 12 },
    { name: "Thrombonorm 0.5mg (لجنة عليا)", unit: "100 Cap", price: 12 },
    { name: "Tiratam 1000 mg (تم الصرف بالاسم التجاري وفقا لتأشيرة الشئون الطبية)", unit: "10 T", price: 12 },
    { name: "Tiratam 500mg (استثناء من مدير الفرع)", unit: "10 T", price: 12 },
    { name: "Topiramate 100 mg", unit: "10 T", price: 12 },
    { name: "Topiramate 25 mg", unit: "10 T", price: 12 },
    { name: "Torsemide 20mg", unit: "10 T", price: 12 },
    { name: "Tranexamic acid 500mg", unit: "10 T", price: 12 },
    { name: "Travoprost ED", unit: "B", price: 12 },
    { name: "Triamcinilone 40mg", unit: "Amp", price: 12 },
    { name: "Trifluperazine 5mg (Stellasil)", unit: "10 T", price: 12 },
    { name: "Trimebutine 200mg", unit: "10 T", price: 12 },
    { name: "Trimetazidine 20mg", unit: "10 T", price: 12 },
    { name: "Urinex", unit: "12 Cap", price: 12 },
    { name: "Ursodeoxycholic acid 250mg", unit: "10 Cap", price: 12 },
    { name: "Valcyte 450mg", unit: "60 T", price: 12 },
    { name: "Valsartan 160mg", unit: "10T", price: 12 },
    { name: "Valsartan 160mg & Amlodipine 10mg", unit: "10 T", price: 12 },
    { name: "Valsartan 160mg & Amlodipine 5mg", unit: "10 T", price: 12 },
    { name: "Valsartan 160mg & HCT 25mg", unit: "10 T", price: 12 },
    { name: "Valsartan 40 mg", unit: "10 T", price: 12 },
    { name: "Vastarel MR ( حكم قضائي )", unit: "30 T", price: 12 },
    { name: "Verapamil 240mg", unit: "10 T", price: 12 },
    { name: "Verapamil 80mg", unit: "10 T", price: 12 },
    { name: "Vidaza 100mg", unit: "Vial", price: 12 },
    { name: "Vildagliptin 50mg", unit: "10 T", price: 12 },
    { name: "Vildagliptin 50mg & Metformin 1000mg", unit: "10 T", price: 12 },
    { name: "Vildagliptin 50mg & Metformin 850mg", unit: "10 T", price: 12 },
    { name: "Vildagluse plus 50/1000mg (حكم قضائي )", unit: "30 T", price: 12 },
    { name: "Vinblastin 10mg", unit: "vial", price: 12 },
    { name: "Vincamine 30mg", unit: "10 T", price: 12 },
    { name: "Vincristine 1mg", unit: "Vial", price: 12 },
    { name: "Vinorelbine 50mg", unit: "Vial", price: 12 },
    { name: "Vitamin A", unit: "10 T", price: 12 },
    { name: "Vitamin B amp", unit: "Amp", price: 12 },
    { name: "Vitamin B comp", unit: "10 T", price: 12 },
    { name: "Vitamin E 400", unit: "12 Cap", price: 12 },
    { name: "Vitamin K", unit: "10 T", price: 12 },
    { name: "Voriconazole 50mg", unit: "10 T", price: 12 },
    { name: "Warfarin 1mg", unit: "10 T", price: 12 },
    { name: "Warfarin 3mg", unit: "10 T", price: 12 },
    { name: "Warfarin 5 mg", unit: "10 T", price: 12 },
    { name: "Xarelto 15 mg (قرار لجنة)", unit: "42 T", price: 12 },
    { name: "Xarelto 20mg", unit: "28 T", price: 12 },
    { name: "Xgeva", unit: "Vial", price: 12 },
    { name: "Zoledronic 4mg", unit: "Vial", price: 12 }
];

const pharmacyOptions = {
    student: {
        first: [
            { name: "ابو المطامير طلاب", id: "a11" }, { name: "ادكو طلاب", id: "a12" },
            { name: "البيضا طلاب", id: "a13" }, { name: "النوبارية طلاب", id: "a14" },
            { name: "رشيد طلاب", id: "a15" }, { name: "كفر الدوار طلاب", id: "a16" }
        ],
        second: [
            { name: "ابو حمص طلاب", id: "a21" }, { name: "اورام طلاب", id: "a22" },
            { name: "الرحمانية طلاب", id: "a23" }, { name: "المحمودية طلاب", id: "a24" },
            { name: "حوش عيسي طلاب", id: "a25" }, { name: "دمنهور طلاب", id: "a26" }
        ],
        third: [
            { name: "ايتاي طلاب", id: "a31" }, { name: "بدر طلاب", id: "a32" },
            { name: "الدلنجات طلاب", id: "a33" }, { name: "كوم حمادة طلاب", id: "a34" },
            { name: "شبراخيت طلاب", id: "a35" }
        ]
    },
    workforce: {
        first: [
           { name: "ابو المطامير", id: "b11" }, { name: "ادكو", id: "b12" },
           { name: "البيضا", id: "b13" }, { name: "النوبارية", id: "b14" },
           { name: "رشيد", id: "b15" }, { name: "كفر الدوار سكر", id: "b16" },
           { name: "كفر الدوار الشاملة 1", id: "b17" }, { name: "كفر الدوار الشاملة 2", id: "b18" },
           { name: "كفر الدوار مسائي", id: "b19" }
        ],
        second: [
            { name: "ابو حمص", id: "b21" }, { name: "الرحمانية", id: "b22" },
            { name: "المحمودية", id: "b23" }, { name: "المحمودية مسائي", id: "b24" },
            { name: "حوش عيسي", id: "b25" }, { name: "دمنهور الشاملة 1", id: "b26" },
            { name: "دمنهور الشاملة 2", id: "b27" }, { name: "دمنهور سكر", id: "b28" },
            { name: "دمنهور مسائي", id: "b29" }, { name: "دمنهور اورام", id: "b210" },
            { name: "الشرطة", id: "b211" }
        ],
        third: [
            { name: "ايتاي الشاملة 1", id: "b31" }, { name: "ايتاي الشاملة 2", id: "b32" },
            { name: "ايتاي مسائي", id: "b33" }, { name: "بدر", id: "b34" },
            { name: "الدلنجات", id: "b35" }, { name: "كوم حمادة", id: "b36" },
            { name: "كوم حمادة مسائي", id: "b37" }, { name: "شبراخيت", id: "b38" },
            { name: "قليشان", id: "b39" }, { name: "وادي النطرون", id: "b310" }
        ]
    }
};

const fuseOptions = { keys: ['name'], includeScore: true, threshold: 0.4, minMatchCharLength: 2 };
const fuse = new Fuse(items, fuseOptions);

const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

const CustomModal = {
    overlay: document.getElementById('customModalOverlay'),
    modal: document.getElementById('customModal'),
    title: document.getElementById('modalTitle'),
    message: document.getElementById('modalMessage'),
    confirmBtn: document.getElementById('modalConfirmBtn'),
    cancelBtn: document.getElementById('modalCancelBtn'),
    _onConfirm: null,

    init() {
        this.confirmBtn.addEventListener('click', () => this.handleConfirm());
        this.cancelBtn.addEventListener('click', () => this.hide());
        this.overlay.addEventListener('click', (e) => {
            if (e.target === this.overlay) this.hide();
        });
    },

    show(config) {
        this.title.textContent = config.title;
        this.message.innerHTML = config.message;
        this._onConfirm = config.onConfirm || (() => this.hide());
        this.confirmBtn.style.display = config.showConfirm === false ? 'none' : 'inline-block';
        this.cancelBtn.style.display = config.showCancel === false ? 'none' : 'inline-block';
        this.overlay.classList.add('visible');
    },

    hide() {
        this.overlay.classList.remove('visible');
    },

    handleConfirm() {
        if (this._onConfirm) this._onConfirm();
        this.hide();
    },

    alert(title, message) {
        this.show({ title, message, showCancel: false });
    }
};
CustomModal.init();

const Toast = {
    element: document.getElementById('undoToast'),
    messageEl: document.getElementById('undoMessage'),
    undoBtn: document.getElementById('undoBtn'),
    timeout: null,
    _onUndo: null,

    init() {
        this.undoBtn.addEventListener('click', () => this.handleUndo());
    },

    show(message, onUndo) {
        clearTimeout(this.timeout);
        this.messageEl.textContent = message;
        this._onUndo = onUndo;
        this.element.classList.add('show');
        this.timeout = setTimeout(() => this.hide(), 5000);
    },

    hide() {
        clearTimeout(this.timeout);
        this.element.classList.remove('show');
        this._onUndo = null;
    },

    handleUndo() {
        if (this._onUndo) this._onUndo();
        this.hide();
    }
};
Toast.init();


function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function autoFillFromId() {
    if (isSubmitting || isUpdatingFromDropdowns) return;
    isUpdatingFromId = true;

    const id = idInput.value.trim().toLowerCase();
    let derivedClass = '';
    let derivedRegion = '';
    let derivedPharmacyName = ''; 

    if (id.length >= 1) {
        const classChar = id[0];
        if (classChar === 'a') derivedClass = 'student';
        else if (classChar === 'b') derivedClass = 'workforce';
    }

    if (id.length >= 2 && derivedClass) {
        const regionChar = id[1];
        const regionMap = { '1': 'first', '2': 'second', '3': 'third' };
        derivedRegion = regionMap[regionChar] || '';
    }
    
    if (id.length >= 3 && derivedClass && derivedRegion) {
        const pharmaciesInRegion = pharmacyOptions[derivedClass]?.[derivedRegion] || [];
        const matchedPharmacy = pharmaciesInRegion.find(p => p.id === id);
        if (matchedPharmacy) {
            derivedPharmacyName = matchedPharmacy.name;
        }
    }

    if (selectedClass !== derivedClass) {
        selectedClass = derivedClass;
        classButtons.forEach(btn => btn.classList.toggle('selected', btn.dataset.class === selectedClass));
    }

    if (regionSelect.value !== derivedRegion) {
        regionSelect.value = derivedRegion;
    }
    
    updatePharmacies(); 

    if (pharmacySelect.value !== derivedPharmacyName) {
        pharmacySelect.value = derivedPharmacyName;
    }
    
    renderPharmacyList();
    isUpdatingFromId = false;
}


function updateIdFromDropdowns() {
    if (isSubmitting || isUpdatingFromId) return; 
    isUpdatingFromDropdowns = true; 

    let newId = "";
    if (selectedClass) {
        newId = (selectedClass === 'student' ? 'a' : 'b');
        const region = regionSelect.value;
        if (region) {
            newId += (region === 'first' ? '1' : (region === 'second' ? '2' : '3'));
            const pharmacyName = pharmacySelect.value;
            if (pharmacyName) {
                const pharmacyData = pharmacyOptions[selectedClass]?.[region]?.find(p => p.name === pharmacyName);
                if (pharmacyData) {
                    newId = pharmacyData.id; 
                }
            }
        }
    }

    if (idInput.value !== newId) {
        idInput.value = newId;
    }
    isUpdatingFromDropdowns = false;
}


function updatePharmacies() {
    const region = regionSelect.value;
    const currentPharmacyValue = pharmacySelect.value;
    let options = ['<option value="" disabled selected>Select Pharmacy</option>'];
    let pharmacyStillExists = false;

    if (selectedClass && region && pharmacyOptions[selectedClass] && pharmacyOptions[selectedClass][region]) {
        pharmacyOptions[selectedClass][region].forEach(pharmacy => {
            const isSelected = pharmacy.name === currentPharmacyValue;
            options.push(`<option value="${pharmacy.name}" ${isSelected ? 'selected' : ''}>${pharmacy.name}</option>`);
            if (isSelected) pharmacyStillExists = true;
        });
    }
    pharmacySelect.innerHTML = options.join('');
    if (!pharmacyStillExists) { 
        pharmacySelect.value = ""; 
    }
    
    updateIdFromDropdowns(); 
}

function renderPharmacyList() {
    const fragment = document.createDocumentFragment();
    if (selectedClass && regionSelect.value && pharmacyOptions[selectedClass]?.[regionSelect.value]) {
        pharmacyOptions[selectedClass][regionSelect.value].forEach(pharmacy => {
            const div = document.createElement('div');
            div.className = 'pharmacy-item';
            div.textContent = `${pharmacy.name} (${pharmacy.id})`;
            div.addEventListener('click', () => {
                if (!isSubmitting) {
                    idInput.value = pharmacy.id;
                    autoFillFromId(); 
                }
            });
            fragment.appendChild(div);
        });
    }
    pharmacyList.innerHTML = '';
    pharmacyList.appendChild(fragment);
}

function handleSearch() {
    if (isSubmitting) return;
    const query = searchBar.value.trim();
    suggestions.innerHTML = '';
    didYouMean.innerHTML = '';
    if (query.length < 2) return;

    const searchResults = fuse.search(query);
    if (searchResults.length > 0) {
        const selectedItemsSet = new Set(selectedItems.map(item => item.name));
        const suggestionsFragment = document.createDocumentFragment();
        searchResults.slice(0, 5).forEach(({ item }) => {
            const div = document.createElement('div');
            div.innerHTML = `<strong>${highlightMatches(item.name, query)}</strong><br><small>${item.unit} - ${item.price}</small>`;
            div.addEventListener('click', () => !isSubmitting && addItem(item));
            if (selectedItemsSet.has(item.name)) div.classList.add('duplicate');
            suggestionsFragment.appendChild(div);
        });
        suggestions.appendChild(suggestionsFragment);

        if (searchResults[0].score > 0.1 && searchResults[0].item.name.toLowerCase() !== query.toLowerCase()) {
            const didYouMeanHeader = document.createElement('div');
            didYouMeanHeader.textContent = 'Did you mean:';
            didYouMean.appendChild(didYouMeanHeader);
            const topSuggestionDiv = document.createElement('div');
            topSuggestionDiv.textContent = searchResults[0].item.name;
            topSuggestionDiv.addEventListener('click', () => {
                if (!isSubmitting) { 
                    addItem(searchResults[0].item);
                }
            });
            didYouMean.appendChild(topSuggestionDiv);
        }
    } else {
        suggestions.innerHTML = '<div>No results found.</div>';
    }
}

function highlightMatches(text, query) {
    const regex = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

function addItem(item) {
    if (isSubmitting) return;
    if (selectedItems.some(i => i.name === item.name)) {
        CustomModal.alert("Duplicate Item", `<strong>${item.name}</strong> is already in the list. You can adjust its quantity in the table.`);
        searchBar.value = '';
        suggestions.innerHTML = '';
        didYouMean.innerHTML = '';
        return;
    }
    selectedItems.push({ ...item, unitsSold: 1 });
    renderTable({ isNew: true });
    saveState();
    searchBar.value = '';
    suggestions.innerHTML = '';
    didYouMean.innerHTML = '';
}

function removeItem(index) {
    if (isSubmitting) return;

    const row = dataTable.rows[index];
    if (!row) return;

    lastDeleted = { item: { ...selectedItems[index] }, index };
    
    const rowHeight = row.offsetHeight;
    row.style.setProperty('--row-height', `${rowHeight}px`);
    row.classList.add('row-deleting');

    row.addEventListener('animationend', () => {
        selectedItems.splice(index, 1);
        renderTable(); 
        saveState();
    }, { once: true });

    Toast.show('Item removed.', () => {
        if (lastDeleted) {
            selectedItems.splice(lastDeleted.index, 0, lastDeleted.item);
            renderTable({ isNew: true, newIndex: lastDeleted.index });
            saveState();
            lastDeleted = null;
        }
    });
}

function renderTable({ isNew = false, newIndex = -1 } = {}) {
    dataTable.innerHTML = '';
    selectedItems.forEach((item, index) => {
        const row = dataTable.insertRow();
        
        row.insertCell(0).textContent = item.name;
        row.insertCell(1).textContent = item.unit;
        
        const unitsSoldCell = row.insertCell(2);
        unitsSoldCell.className = 'editable';
        const unitsSoldInput = document.createElement('input');
        unitsSoldInput.type = 'number';
        unitsSoldInput.value = item.unitsSold;
        unitsSoldInput.min = 1;
        unitsSoldInput.required = true;
        unitsSoldInput.addEventListener('change', (e) => {
            if (!isSubmitting) {
                const value = parseInt(e.target.value);
                item.unitsSold = value > 0 ? value : 1;
                e.target.value = item.unitsSold; 
                saveState();
            } else {
                e.preventDefault();
            }
        });
        unitsSoldInput.addEventListener('input', (e) => { 
             if (parseInt(e.target.value) < 1) e.target.classList.add('error-input');
             else e.target.classList.remove('error-input');
        });
        unitsSoldCell.appendChild(unitsSoldInput);

        const actionsCell = row.insertCell(3);
        const deleteBtnEl = document.createElement('button');
        deleteBtnEl.innerHTML = '<i class="material-icons">delete_outline</i>';
        deleteBtnEl.classList.add('action-btn', 'delete-btn');
        deleteBtnEl.title = "Delete item";
        deleteBtnEl.addEventListener('click', () => removeItem(index));
        actionsCell.appendChild(deleteBtnEl);
        
        if (isNew && index === (newIndex !== -1 ? newIndex : selectedItems.length - 1)) {
            row.classList.add('new-row');
            const quantityInput = row.querySelector('input[type="number"]');
            if (quantityInput) {
                setTimeout(() => quantityInput.focus(), 100);
            }
            row.addEventListener('animationend', () => {
                row.classList.remove('new-row');
            }, { once: true });
        }
    });
}


function saveState() {
    localStorage.setItem('pharmacyAppState', JSON.stringify({
        id: idInput.value, class: selectedClass, region: regionSelect.value,
        pharmacy: pharmacySelect.value, month: monthInput.value, items: selectedItems
    }));
}

function loadState() {
    const state = JSON.parse(localStorage.getItem('pharmacyAppState'));
    if (state) {
        const tempIsUpdatingFromId = isUpdatingFromId;
        const tempIsUpdatingFromDropdowns = isUpdatingFromDropdowns;
        isUpdatingFromId = true; 
        isUpdatingFromDropdowns = true; 

        idInput.value = state.id || ''; 
        
        selectedClass = state.class || '';
        classButtons.forEach(btn => btn.classList.toggle('selected', btn.dataset.class === selectedClass));
        
        regionSelect.value = state.region || '';
        
        const currentPharmacyValInState = state.pharmacy || '';
        let options = ['<option value="" disabled selected>Select Pharmacy</option>'];
        if (selectedClass && regionSelect.value && pharmacyOptions[selectedClass] && pharmacyOptions[selectedClass][regionSelect.value]) {
            pharmacyOptions[selectedClass][regionSelect.value].forEach(pharmacy => {
                options.push(`<option value="${pharmacy.name}" ${pharmacy.name === currentPharmacyValInState ? 'selected' : ''}>${pharmacy.name}</option>`);
            });
        }
        pharmacySelect.innerHTML = options.join('');
        pharmacySelect.value = currentPharmacyValInState; 
        
        monthInput.value = state.month || '';
        selectedItems = state.items || [];

        isUpdatingFromId = tempIsUpdatingFromId;
        isUpdatingFromDropdowns = tempIsUpdatingFromDropdowns;

        if (state.id && state.id.trim() !== '') {
             autoFillFromId(); 
        } else {
            updateIdFromDropdowns(); 
        }

        renderTable();
        renderPharmacyList(); 
    }
}


function validateAndSubmit() {
    if (isSubmitting) return;

    const isIdValid = idInput.value.trim() !== '';
    const isClassSelected = selectedClass !== '';
    const isRegionSelected = regionSelect.value !== '';
    const isPharmacySelected = pharmacySelect.value !== '';
    const isMonthValid = monthInput.value !== '' && parseInt(monthInput.value) >= 1 && parseInt(monthInput.value) <= 12;
    const hasItems = selectedItems.length > 0;
    const allQuantitiesValid = selectedItems.every(item => item.unitsSold > 0);

    let errors = [];
    if (!isIdValid) errors.push("ID is missing.");
    if (!isClassSelected) errors.push("Class (Student/Workforce) selection is required.");
    if (!isRegionSelected) errors.push("Region selection is required.");
    if (!isPharmacySelected) errors.push("Pharmacy selection is required.");
    if (!isMonthValid) errors.push("Month must be a valid number between 1 and 12.");
    if (!hasItems) errors.push("At least one item must be added to the list.");
    if (!allQuantitiesValid) errors.push("All items must have a quantity greater than 0.");

    if (errors.length > 0) {
        CustomModal.alert("Validation Error", "Please correct the following errors:<br>- " + errors.join("<br>- "));
        return;
    }
    submitToFirebase();
}

function submitToFirebase() {
    if (isSubmitting) return;
    isSubmitting = true;
    disableInputs();

    const flatData = {
        id: idInput.value.trim(), class: selectedClass, region: regionSelect.value,
        pharmacy: pharmacySelect.value, month: parseInt(monthInput.value),
        timestamp: firebase.database.ServerValue.TIMESTAMP, items: {}
    };
    selectedItems.forEach((item, index) => {
        flatData.items[`item_${index + 1}`] = {
            name: item.name, unit: item.unit, unitsSold: item.unitsSold, price: item.price
        };
    });
    
    const key = `${flatData.pharmacy}_${flatData.month}_${flatData.class}`;
    
    db.ref('pharmacyInventory').child(key).set(flatData)
        .then(() => {
            CustomModal.alert('Success!', 'Your data has been submitted successfully.');
            clearForm();
            localStorage.removeItem('pharmacyAppState'); 
        })
        .catch((error) => {
            console.error("Error writing document: ", error);
            let errorMessage = 'An error occurred. ';
            if (!navigator.onLine) errorMessage += 'You appear to be offline. Check connection.';
            else if (error.code === 'PERMISSION_DENIED') errorMessage += 'Submission for this pharmacy, month, and class may already exist or you lack permission.';
            else errorMessage += 'Please try again. Contact support if issues persist.';
            CustomModal.alert('Submission Failed', errorMessage);
        })
        .finally(() => {
            isSubmitting = false;
            enableInputs();
        });
}

function disableInputs() {
    document.querySelectorAll('#screen1 input, #screen1 select, #screen1 button, #screen2 input, #screen2 button, #screen2 .action-btn').forEach(el => el.disabled = true);
    submitBtn.innerHTML = '<i class="material-icons spin">sync</i>Submitting...';
    const spinIcon = submitBtn.querySelector('.material-icons.spin');
    if(spinIcon) { 
        let rotation = 0;
        spinIcon.dataset.intervalId = setInterval(() => {
            rotation = (rotation + 15) % 360;
            spinIcon.style.transform = `rotate(${rotation}deg)`;
        }, 50);
    }
}

function enableInputs() {
    document.querySelectorAll('#screen1 input, #screen1 select, #screen1 button, #screen2 input, #screen2 button, #screen2 .action-btn').forEach(el => el.disabled = false);
    const spinIcon = submitBtn.querySelector('.material-icons.spin');
    if(spinIcon && spinIcon.dataset.intervalId) {
        clearInterval(parseInt(spinIcon.dataset.intervalId));
        spinIcon.style.transform = ''; 
        spinIcon.classList.remove('spin'); 
    }
    submitBtn.innerHTML = '<i class="material-icons">send</i>Submit';
}


function clearForm() {
    idInput.value = '';
    selectedClass = '';
    classButtons.forEach(btn => btn.classList.remove('selected'));
    regionSelect.value = '';
    pharmacySelect.innerHTML = '<option value="" disabled selected>Select Pharmacy</option>'; 
    pharmacySelect.value = ''; 
    monthInput.value = '';
    selectedItems = [];
    renderTable();
    renderPharmacyList(); 
    saveState(); 
    screen2.classList.add('hidden');
    screen1.classList.remove('hidden');
}

idInput.addEventListener('input', debounce(autoFillFromId, 300));

classButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        if (isSubmitting || isUpdatingFromId) return; 
        isUpdatingFromDropdowns = true; 

        const newClass = btn.dataset.class;
        if (selectedClass === newClass) { 
            selectedClass = "";
            btn.classList.remove('selected');
        } else {
            selectedClass = newClass;
            classButtons.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }
        
        regionSelect.value = ""; 
        updatePharmacies(); 
        renderPharmacyList(); 

        isUpdatingFromDropdowns = false;
    });
});

regionSelect.addEventListener('change', () => {
    if (isSubmitting || isUpdatingFromId) return;
    isUpdatingFromDropdowns = true;

    updatePharmacies(); 
    renderPharmacyList();

    isUpdatingFromDropdowns = false;
});

pharmacySelect.addEventListener('change', () => {
    if (isSubmitting || isUpdatingFromId) return;
    isUpdatingFromDropdowns = true;
    
    updateIdFromDropdowns(); 

    isUpdatingFromDropdowns = false;
});


nextBtn.addEventListener('click', () => {
    const isIdValid = idInput.value.trim() !== '';
    const isClassSelected = selectedClass !== '';
    const isRegionSelected = regionSelect.value !== '';
    const isPharmacySelected = pharmacySelect.value !== '';
    const isMonthValid = monthInput.value !== '' && parseInt(monthInput.value) >= 1 && parseInt(monthInput.value) <= 12;

    let errors = [];
    if (!isIdValid) errors.push("ID is missing.");
    if (!isClassSelected) errors.push("Class (Student/Workforce) selection is required.");
    if (!isRegionSelected) errors.push("Region selection is required.");
    if (!isPharmacySelected) errors.push("Pharmacy selection is required.");
    if (!isMonthValid) errors.push("Month must be a valid number between 1 and 12.");
    
    if (errors.length > 0) {
         CustomModal.alert("Incomplete Information", "Please complete all fields on this page before proceeding:<br>- " + errors.join("<br>- "));
         return;
    }

    document.getElementById('summary-class').textContent = selectedClass.charAt(0).toUpperCase() + selectedClass.slice(1);
    document.getElementById('summary-region').textContent = regionSelect.options[regionSelect.selectedIndex].text;
    document.getElementById('summary-pharmacy').textContent = pharmacySelect.value;
    const monthIndex = parseInt(monthInput.value) - 1;
    document.getElementById('summary-month').textContent = monthNames[monthIndex] || monthInput.value;
    document.getElementById('summary-id').textContent = idInput.value.toUpperCase();

    screen1.classList.add('hidden');
    screen2.classList.remove('hidden');
    searchBar.focus();
});
backBtn.addEventListener('click', () => {
    screen2.classList.add('hidden');
    screen1.classList.remove('hidden');
});
searchBar.addEventListener('input', debounce(handleSearch, 250));
submitBtn.addEventListener('click', validateAndSubmit);

loadState();

</script>
</body>
</html>
